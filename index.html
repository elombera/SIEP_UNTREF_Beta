<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Acceso - SIEP UNTREF</title>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            background-color: #ffffff;
            border-bottom: 2px solid #000000;
            position: relative;
            z-index: 1001;
            transition: margin-left 0.3s ease;
        }

            header.shifted {
                margin-left: 160px;
            }

            header img {
                height: 60px;
                margin-right: 20px;
            }

            header h1 {
                font-size: 24px;
                color: #000000;
                margin: 0;
            }

            header h2 {
                margin: 0 0 0 0;
                font-weight: normal;
                font-size: 18px;
                color: #333;
                margin-left: 10px;
            }
        .container {
            width: 500px;
            height: 500px; 
            background: white;
            padding: 30px 25px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: stretch;
            margin: auto;
        }

        #auth-container {
            display: none;
        }
        .formulario {
            display: none;
        }

            .formulario.activo {
                display: block;
            }

        h3 {
            margin-bottom: 20px;
        }

        .input-wrapper {
            position: relative;
            margin-bottom: 15px;
        }

            .input-wrapper input {
                width: 100%;
                padding: 10px;
                box-sizing: border-box;
                font-size: 14px;
            }

                /* SOLO si hay toggle-password */
                .input-wrapper input + .toggle-password {
                    margin-left: -40px; 
                }

        .toggle-password {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 18px;
            color: #444;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            display: inline-block;
            overflow: hidden;
            user-select: none;
        }

        input[type="email"], input[type="text"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 0px;
            box-sizing: border-box;
            font-size: 14px;
        }

        button {
            width: 100%;
            padding: 12px;
            background-color: #004080;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            margin-top: 0px;
        
        }

            button:hover {
                background-color: #003060;
            }

        .link {
            display: block;
            margin-top: 10px;
            text-align: center;
            color: #004080;
            cursor: pointer;
            font-size: 14px;
        }
        #menu-toggle {
            position: fixed;
            top: 85px; /* justo debajo del header */
            left: 1px;
            font-size: 18px;
            cursor: pointer;
            transition: left 0.3s ease;
            z-index: 1002;
            display: none;
            background-color: rgba(0, 64, 128, 0.95);
            padding: 8px 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            color: white;
        }

        #sidebar {
            position: fixed;
            top: 0px; /* debajo del header */
            left: -160px;
            width: 160px;
            height: calc(100% - 0px);
            background-color: rgba(0, 64, 128, 0.95); /* azul con transparencia */
            color: white;
            padding-top: 20px;
            transition: left 0.3s ease;
            z-index: 1000;
        }

            #sidebar ul {
                list-style: none;
                padding: 0;
                margin: 0;
            }

                #sidebar ul li {
                    padding: 12px 20px;
                    border-bottom: 1px solid #003060;
                }

                    #sidebar ul li a {
                        color: white;
                        text-decoration: none;
                        display: block;
                    }
        #main-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        #main-content {
            transition: margin-left 0.3s ease;
            padding: 50px;
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        .contenido-principal {
            flex: 1;
        }

        body.sidebar-open #sidebar {
            left: 0;
        }

        body.sidebar-open #main-content,
        body.sidebar-open header {
            margin-left: 160px;
        }

        body.sidebar-open #menu-toggle {
            left: 161px;
        }
        footer {
            background-color: #002855;
            color: white;
            text-align: center;
            padding: 20px;
            font-size: 14px;
            margin-top: auto;
        }

        .footer-redes {
            margin-top: 10px;
        }

            .footer-redes a {
                margin: 0 10px;
                display: inline-block;
            }

            .footer-redes img {
                height: 24px;
                width: 24px;
            }
        .tabla-proyectos {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 12px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }

            .tabla-proyectos th,
            .tabla-proyectos td {
                padding: 12px 16px;
                text-align: left;
            }
                .tabla-proyectos td:nth-child(1), /* ESTADO */
                .tabla-proyectos td:nth-child(2), /* C√ìDIGO */
                .tabla-proyectos td:nth-child(4), /* CONVOCATORIA */
                .tabla-proyectos td:nth-child(5), /* PERIODO */
                .tabla-proyectos td:nth-child(6), /* EJECUCI√ìN PRESUPUESTARIA */
                .tabla-proyectos td:nth-child(7), /* INFORMES ACAD√âMICOS */
                .tabla-proyectos td:nth-child(8) { /* ACCIONES */
                    text-align: center;
                }

            .tabla-proyectos th {
                background-color: #004080;
                color: #ffffff;
                font-weight: bold;
                text-transform: uppercase;
                text-align: center;
            }
            .tabla-proyectos td:nth-child(1) {
                min-width: 90px;
            }
            .tabla-proyectos td:nth-child(2) {
                min-width: 10px;
            }
            .tabla-proyectos td:nth-child(4) {
                min-width: 90px;
            }
            .tabla-proyectos td:nth-child(5) {
                min-width: 90px;
            }
            .tabla-proyectos td:nth-child(7) {
                min-width: 90px;
            }
            .tabla-proyectos tr:nth-child(even) {
                background-color: #f5f5f5;
            }

            .tabla-proyectos tr:hover {
                background-color: #e0ecf7;
            }

        .tabla-ver-proyecto {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

            .tabla-ver-proyecto th {
                text-align: left;
                background-color: rgba(33, 97, 140, 0.08);
                color: #333;
                padding: 4px 6px; /* m√°s compacto */
                width: 25%;
                vertical-align: top;
                border: 1px solid #ddd;
                white-space: nowrap;
            }

            .tabla-ver-proyecto td {
                padding: 4px 6px; /* m√°s compacto */
                vertical-align: top;
                border: 1px solid #ddd;
                background-color: #fff;
            }

            .tabla-ver-proyecto tr:nth-child(even) td {
                background-color: #f9f9f9;
            }

        
        .btn-volver {
            padding: 6px 12px;
            font-size: 13px;
            width: auto;
            max-width: fit-content;
        }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-button {
            padding: 10px 18px;
            background-color: #004080;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

            .form-button:hover {
                background-color: #0059b3;
            }
        .boton-adjuntar {
            display: inline-block;
            background-color: #f0f0f0;
            color: #004080;
            padding: 6px 14px;
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: 1px solid #c0c0c0;
        }

            .boton-adjuntar:hover {
                background-color: #e0e0e0;
            }
        .info-box {
            background: #f7f7f7;
            border: 1px solid #ccc;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 14px;
        }
        .tablink {
            padding: 10px 18px;
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ccc;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            font-size: 14px;
            font-weight: 500;
        }

            .tablink:hover {
                background-color: #d0e4f7;
                color: #000;
            }

            .tablink.active {
                background-color: #e0f0ff;
                border-bottom: 1px solid white;
                color: #000;
                font-weight: 600;
            }
    </style>
</head>

<body>
    <header>
        <img src="https://i.postimg.cc/4dx5PqYF/Captura-de-pantalla-2025-05-03-091928.png" alt="Logo UNTREF" />
        <div>
            <h1>Sistema integral para ejecuci√≥n de proyectos I+D (SIEP-UNTREF)</h1>
            <h2>Secretar√≠a de Investigaci√≥n y Desarrollo</h2>
        </div>
    </header>

    <div id="auth-container" class="container">
        <!-- FORMULARIO LOGIN -->
        <div id="form-login" class="formulario activo">
            <h3>Iniciar sesi√≥n</h3>
            <div class="input-wrapper">
                <input type="email" id="login-email" placeholder="Correo electr√≥nico">
            </div>
            <div class="input-wrapper">
                <input type="password" id="login-password" placeholder="Contrase√±a">
                <span onclick="togglePassword('login-password', this)" style="position: absolute; top: 12px; right: 10px; cursor: pointer;">üëÅÔ∏è</span>
            </div>
            <button onclick="loginUsuario()">Ingresar</button>
            <span class="link" onclick="mostrarFormulario('form-reset')">¬øOlvidaste tu contrase√±a?</span>
            <span class="link" onclick="mostrarFormulario('form-register')">¬øNo ten√©s cuenta? Registrate</span>
        </div>

        <div id="form-register" class="formulario">
            <h3>Crear cuenta</h3>
            <div class="input-wrapper">
                <input type="text" id="reg-nombre" placeholder="Nombre" required>
            </div>

            <div class="input-wrapper">
                <input type="text" id="reg-apellido" placeholder="Apellido" required>
            </div>
            <div class="input-wrapper">
                <input type="email" id="reg-email" placeholder="Correo electr√≥nico">
            </div>
            <div class="input-wrapper">
                <input type="text" id="reg-cuit" placeholder="CUIT (11 d√≠gitos)" maxlength="11" pattern="\d{11}" required oninput="validarCUIT(this)">
            </div>
            <div class="input-wrapper">
                <input type="password" id="reg-password" placeholder="Contrase√±a">
                <span onclick="togglePassword('login-password', this)" style="position: absolute; top: 12px; right: 10px; cursor: pointer;">üëÅÔ∏è</span>
            </div>
            <div class="input-wrapper">
                <input type="password" id="reg-password-repeat" placeholder="Repetir contrase√±a">
                <span onclick="togglePassword('login-password', this)" style="position: absolute; top: 12px; right: 10px; cursor: pointer;">üëÅÔ∏è</span>
            </div>
            <button onclick="registrarUsuario()">Registrarse</button>
            <span class="link" onclick="mostrarFormulario('form-login')">¬øYa ten√©s cuenta? Iniciar sesi√≥n</span>
        </div>

        <!-- FORMULARIO RESET -->
        <div id="form-reset" class="formulario">
            <h3>Recuperar contrase√±a</h3>
            <div class="input-wrapper">
                <input type="email" id="reset-email" placeholder="Correo electr√≥nico">
            </div>
            <button onclick="enviarReset()">Enviar correo de recuperaci√≥n</button>
            <span class="link" onclick="mostrarFormulario('form-login')">Volver a iniciar sesi√≥n</span>
        </div>
    </div>

    <div id="main-interface" style="display: none;">
        <div id="menu-toggle" onclick="toggleSidebar()">‚ò∞</div>

        <div id="sidebar">
            <ul>
                <li><a href="#" onclick="mostrarInicio()">Inicio</a></li>
                <li><a href="#mis-proyectos">Mis Proyectos</a></li>
                <li><a href="#" onclick="logout()">Cerrar Sesi√≥n</a></li>
            </ul>
        </div>
        <div id="main-wrapper">
            <div id="main-content">
                <h2 id="saludo-usuario"></h2>
                <div class="contenido-principal">
                    <div id="mis-proyectos">
                        <div id="resultado-proyecto" style="margin-top: 20px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="modal-confirmacion-envio" style="
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 9999;
  justify-content: center;
  align-items: center;
">
        <div style="background: white; padding: 30px; border-radius: 8px; max-width: 400px; text-align: center;">
            <p style="font-size: 16px; margin-bottom: 20px;">
                <strong>Una vez enviada la rendici√≥n no podr√° realizar cambios.</strong><br>¬øEst√° seguro de enviar?
            </p>
            <button onclick="confirmarEnvioRendicion()" style="margin-right: 15px;">S√≠, enviar</button>
            <button onclick="cerrarModalConfirmacion()">Cancelar</button>
        </div>
    </div>
    <footer>
        Secretar√≠a de Investigaci√≥n y Desarrollo - UNTREF<br>
        Los Aromos 6231, Palomar, Buenos Aires, Argentina<br>
        Tel: (011) 4751‚Äì3987/4751‚Äì3979 | Lunes a Viernes de 9 a 17 h
        <div class="footer-redes">
            <a href="https://www.facebook.com/UNTREF" target="_blank"><img src="https://cdn-icons-png.flaticon.com/512/733/733547.png" alt="Facebook" /></a>
            <a href="https://www.instagram.com/untref/" target="_blank"><img src="https://cdn-icons-png.flaticon.com/512/2111/2111463.png" alt="Instagram" /></a>
            <a href="https://www.youtube.com/user/UNTREFTV" target="_blank"><img src="https://cdn-icons-png.flaticon.com/512/1384/1384060.png" alt="YouTube" /></a>
        </div>
    </footer>
    <div id="modal-procesando" style="
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    font-weight: bold;
    text-align: center;
">
        Procesando...
    </div>
    <div id="modal-cargando" style="
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(255, 255, 255, 0.8);
  z-index: 9999;
  justify-content: center;
  align-items: center;
  font-size: 22px;
  font-weight: bold;
  color: #333;
">
        Cargando...
    </div>


    <!-- SDK Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyCdR34NFmPXKFW1tCn-7I6lGcDgB6OrRdU",
            authDomain: "siep-untref.firebaseapp.com",
            projectId: "siep-untref",
            storageBucket: "siep-untref.firebasestorage.app",
            messagingSenderId: "583064354141",
            appId: "1:583064354141:web:94d904919781e77c9ebcb4",
            measurementId: "G-8KWGJF7QJN"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        function mostrarFormulario(id) {
            document.querySelectorAll('.formulario').forEach(f => f.classList.remove('activo'));
            document.getElementById(id).classList.add('activo');
        }

        async function loginUsuario() {
            const email = document.getElementById("login-email").value.trim();
            const password = document.getElementById("login-password").value;

            try {
                const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
                const user = userCredential.user;

                if (!user.emailVerified) {
                    alert("Tu correo no est√° verificado. Revis√° tu bandeja de entrada.");
                    await user.sendEmailVerification();
                    return;
                }

                const doc = await firebase.firestore().collection("usuarios").doc(user.uid).get();
                if (doc.exists) {
                    const data = doc.data();

                    // Mostrar saludo directamente
                    document.getElementById("saludo-usuario").textContent = `Hola ${data.nombre} ${data.apellido}`;

                    // Mostrar interfaz principal
                    document.getElementById("auth-container").style.display = "none";
                    document.getElementById("main-interface").style.display = "block";

                    // Mostrar bot√≥n hamburguesa (ya est√° en main-interface)
                    document.getElementById("menu-toggle").style.display = "block";
                } else {
                    alert("No se encontraron los datos del usuario.");
                }

            } catch (error) {
                let mensaje;
                switch (error.code) {
                    case "auth/invalid-email":
                    case "auth/user-not-found":
                    case "auth/wrong-password":
                    case "auth/invalid-credential":
                        mensaje = "Correo electr√≥nico y/o contrase√±a incorrectos.";
                        break;
                    case "auth/too-many-requests":
                        mensaje = "Demasiados intentos fallidos. Esper√° un momento antes de intentar nuevamente.";
                        break;
                    default:
                        console.error("Error desconocido:", error);
                        mensaje = "Ocurri√≥ un error inesperado al iniciar sesi√≥n.";
                }
                alert(mensaje);
            }
        }

        async function registrarUsuario() {
            const nombre = document.getElementById("reg-nombre").value.trim();
            const apellido = document.getElementById("reg-apellido").value.trim();
            const email = document.getElementById("reg-email").value.trim();
            const password = document.getElementById("reg-password").value;
            const repeat = document.getElementById("reg-password-repeat").value;
            const cuit = document.getElementById("reg-cuit").value.trim();

            // Validaciones
            if (!nombre || !apellido || !email || !password || !repeat || !cuit) {
                alert("Complet√° todos los campos.");
                return;
            }

            if (!/^\d{11}$/.test(cuit)) {
                alert("El CUIT debe contener exactamente 11 n√∫meros.");
                return;
            }

            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                alert("Ingres√° un correo electr√≥nico v√°lido.");
                return;
            }

            if (password !== repeat) {
                alert("Las contrase√±as no coinciden.");
                return;
            }

            try {
                // Crear usuario
                const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Guardar en Firestore
                await firebase.firestore().collection("usuarios").doc(user.uid).set({
                    nombre,
                    apellido,
                    email,
                    cuit
                });

                // Enviar email de verificaci√≥n
                await user.sendEmailVerification();

                // Mensaje claro
                alert("Cuenta creada. Se envi√≥ un correo a tu direcci√≥n para verificar tu cuenta. Por favor, revis√° tu bandeja de entrada o correo no deseado.");

                // Redirigir al login
                mostrarFormulario("form-login");

            } catch (error) {
                alert("Error al registrarse: " + error.message);
            }
        }

        async function enviarReset() {
            const email = document.getElementById("reset-email").value.trim();
            try {
                await auth.sendPasswordResetEmail(email);
                alert("Correo de recuperaci√≥n enviado");
                mostrarFormulario('form-login');
            } catch (error) {
                alert("Error: " + error.message);
            }
        }
    </script>
    <script>
        function togglePassword(inputId, icon) {
            const input = document.getElementById(inputId);
            if (input.type === "password") {
                input.type = "text";
                icon.textContent = "üôà";
            } else {
                input.type = "password";
                icon.textContent = "üëÅÔ∏è";
            }
        }
    </script>
    <script>
        // Validaci√≥n de email
        function esEmailValido(email) {
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return regex.test(email);
        }

        // Solo n√∫meros para CUIT (se puede usar como oninput="soloNumeros(this)")
        function soloNumeros(input) {
            input.value = input.value.replace(/\D/g, '');
        }
    </script>
    <script>
        function toggleSidebar() {
            document.body.classList.toggle("sidebar-open");
        }
    </script>
    <script>
        function mostrarInicio() {
            document.querySelector(".contenido-principal").innerHTML = `
                                                                                                                                                                                                                                                                    <h2 id="saludo-usuario"></h2>
                                                                                                                                                                                                                                                                `;

            // Mostrar saludo nuevamente (si quer√©s volverlo a cargar)
            const user = firebase.auth().currentUser;
            if (user) {
                firebase.firestore().collection("usuarios").doc(user.uid).get().then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        document.getElementById("saludo-usuario").textContent = `Hola ${data.nombre} ${data.apellido}`;
                    }
                });
            }
        }
    </script>
    <script>
        async function mostrarMisProyectos() {
            if (location.hash !== "#mis-proyectos") {
                location.hash = "#mis-proyectos";
            }
            const contenido = document.querySelector(".contenido-principal");
            contenido.innerHTML = "<p>Cargando proyectos...</p>";

            const user = firebase.auth().currentUser;
            if (!user) {
                contenido.innerHTML = "<p style='color: red;'>Usuario no autenticado.</p>";
                return;
            }
            mostrarCargando();
            try {
                const usuarioDoc = await firebase.firestore().collection("usuarios").doc(user.uid).get();
                if (!usuarioDoc.exists) {
                    contenido.innerHTML = "<p style='color: red;'>Datos del usuario no encontrados.</p>";
                    return;
                }

                const cuitUsuario = usuarioDoc.data().cuit;

                const querySnapshot = await firebase.firestore()
                    .collection("proyectos")
                    .where("cuit", "==", cuitUsuario)
                    .get();

                if (querySnapshot.empty) {
                    contenido.innerHTML = "<p>No se encontraron proyectos asociados a tu CUIT.</p>";
                    return;
                }

                let tablaHTML = `
                                                                                                                                                                            <h3>Mis Proyectos Asociados</h3>
                                                                                                                                                                            <table class="tabla-proyectos" id="tabla-proyectos">
<thead>
                                                                                                                                                            <tr>
                                                                                                                                                                <th onclick="ordenarTabla(0, this)">Estado <span class='flecha'></span></th>
                                                                                                                                                                <th onclick="ordenarTabla(1, this)">C√≥digo <span class='flecha'></span></th>
                                                                                                                                                                <th onclick="ordenarTabla(2, this)">T√≠tulo <span class='flecha'></span></th>
                                                                                                                                                                <th onclick="ordenarTabla(3, this)">Convocatoria <span class='flecha'></span></th>
                                                                                                                                                                <th onclick="ordenarTabla(4, this)">Periodo <span class='flecha'></span></th>
                                                                                                                                                                <th onclick="ordenarTabla(5, this)">Presupuesto <span class='flecha'></span></th>
                                                                                                                                                                <th onclick="ordenarTabla(6, this)">Ejecuci√≥n Presupuestaria</th>
                                                                                                                                                                <th onclick="ordenarTabla(7, this)">Informes Acad√©micos <span class='flecha'></span></th>
                                                                                                                                                                <th>Acciones</th>
                                                                                                                                                            </tr>
</thead>
                                                                                                                                                                                <tbody>
                                                                                                                                                                        `;

                for (const doc of querySnapshot.docs) {
                    const data = doc.data();
                    const idProyecto = doc.id;
                    const codigo = data.Codigo || "-";
                    const presupuesto = parseFloat(data.monto_total || 0);

                    let estado = data.estado || "-";
                    let estiloEstado = "";
                    if (estado.toUpperCase() === "FINALIZADO") {
                        estiloEstado = "background-color: rgba(144, 238, 144, 0.4);";
                    } else if (estado.toUpperCase() === "EN EJECUCION") {
                        estiloEstado = "background-color: rgba(255, 165, 0, 0.3);";
                    }

                    let informes = data.informes_academicos || "-";
                    let estiloInformes = "";
                    if (informes.toUpperCase() === "ENTREGADOS") {
                        estiloInformes = "background-color: rgba(144, 238, 144, 0.4);";
                    } else if (informes.toUpperCase() === "PENDIENTES") {
                        estiloInformes = "background-color: rgba(255, 99, 71, 0.3);";
                    }

                    // Calcular ejecuci√≥n presupuestaria
                    let totalGastado = 0;
                    const gastosSnapshot = await firebase.firestore()
                        .collection("rendiciones")
                        .doc(codigo)
                        .collection("gastos")
                        .get();

                    gastosSnapshot.forEach(gastoDoc => {
                        const gastoData = gastoDoc.data();
                        totalGastado += parseFloat(gastoData.importe || 0);
                    });

                    let porcentaje = 0;
                    if (estado.toUpperCase() === "FINALIZADO") {
                        porcentaje = 100;
                    } else if (presupuesto > 0) {
                        porcentaje = Math.min((totalGastado / presupuesto) * 100, 100);
                    }

                    const barraColor = porcentaje >= 100 || estado.toUpperCase() === "FINALIZADO"
                        ? "#28a745" // verde
                        : "#f0ad4e"; // amarillo

                    const barraHTML = `
                                                                                                                                                                                <div style="width: 100%; background: #eee; height: 10px; border-radius: 5px;">
                                                                                                                                                                                    <div style="width: ${porcentaje.toFixed(0)}%; height: 10px; background: ${barraColor}; border-radius: 5px;"></div>
                                                                                                                                                                                </div>
                                                                                                                                                                                <div><strong>${porcentaje.toFixed(0)}%</strong></div>
                                                                                                                                                                            `;

                    tablaHTML += `
                                                                                                                                                                                <tr>
                                                                                                                                                                                    <td style="${estiloEstado}">${estado}</td>
                                                                                                                                                                                    <td>${codigo}</td>
                                                                                                                                                                                    <td>${data.titulo || "-"}</td>
                                                                                                                                                                                    <td>${data.convocatoria || "-"}</td>
                                                                                                                                                                                    <td>${data.periodo || "-"}</td>
                                                                                                                                                                                    <td>${isNaN(presupuesto) ? "-" : `$${presupuesto.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`}</td>
                                                                                                                                                                                    <td>${barraHTML}</td>
                                                                                                                                                                                    <td style="${estiloInformes}">${informes}</td>
                                                                                                                                                                                    <td><button onclick="verProyecto('${idProyecto}')" style="padding: 6px 12px; font-size: 13px;">Ver</button></td>
                                                                                                                                                                                </tr>
                                                                                                                                                                            `;
                }

                tablaHTML += `
                                                                                                                                                                                </tbody>
                                                                                                                                                                            </table>
                                                                                                                                                                        `;

                contenido.innerHTML = tablaHTML;

            } catch (error) {
                console.error("Error al cargar proyectos:", error);
                contenido.innerHTML = "<p style='color: red;'>Error al cargar proyectos.</p>";
            } finally {
                ocultarCargando();
            }

        }
    </script>

    <script>
        async function verProyecto(projectId) {
            location.hash = `#ver-proyecto-${projectId}`;
            const contenido = document.querySelector(".contenido-principal");
            contenido.innerHTML = "<p>Cargando proyecto...</p>";

            try {
                const doc = await firebase.firestore().collection("proyectos").doc(projectId).get();

                if (!doc.exists) {
                    contenido.innerHTML = "<p style='color: red;'>Proyecto no encontrado.</p>";
                    return;
                }

                const data = doc.data();
                const estado = data.estado || "-";

                // Estilo condicional para ESTADO
                let estiloEstado = "";
                if (estado.toUpperCase() === "FINALIZADO") {
                    estiloEstado = "background-color: rgba(144, 238, 144, 0.4);";
                } else if (estado.toUpperCase() === "EN EJECUCION") {
                    estiloEstado = "background-color: rgba(255, 165, 0, 0.3);";
                }

                // Botones adicionales si el estado es EN EJECUCION
                let botonesExtra = "";
                if (estado.toUpperCase() === "EN EJECUCION") {
                    botonesExtra = `
                                                                                                                                                                                                                                        <div style="display: flex; gap: 150px; margin: 10px 0 30px auto; justify-content: flex-end;">
                                                                                                                                                                                                                                            <button onclick="abrirRendicionFinanciera('${projectId}')" class="btn-secundario">Rendici√≥n financiera</button>
                                                                                                                                                                                                                                            <button onclick="abrirInformesAcademicos('${projectId}')" class="btn-secundario">Informes Acad√©micos</button>
                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                    `;
                }

                contenido.innerHTML = `
                                                                                                                                                                                                                                    <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
                                                                                                                                                                                                                                        <button onclick="volverAMisProyectos()" class="btn-volver">‚¨Ö Volver</button>
                                                                                                                                                                                                                                    </div>

                                                                                                                                                                                                                                    ${botonesExtra}

<h3>Detalle del Proyecto</h3>

<table class="tabla-ver-proyecto">
                                              <tr>
                                                <th>Estado</th>
                                                <td colspan="5" style="${estiloEstado}; font-weight: bold;">${estado}</td>
                                              </tr>

                                              <tr>
                                                <th>T√≠tulo</th>
                                                <td colspan="2">${data.titulo || "-"}</td>
                                                <th>Titular</th>
                                                <td colspan="2">${data.titular || "-"}</td>
                                              </tr>

                                              <tr>
                                                <th>Resumen</th>
                                                <td colspan="5">${data.resumen || "-"}</td>
                                              </tr>

                                              <tr>
                                                <th>C√≥digo SIGEVA</th>
                                                <td>${data.Codigo || "-"}</td>
                                                <th>Convocatoria</th>
                                                <td>${data.convocatoria || "-"}</td>
                                                <th>Periodo</th>
                                                <td>${data.periodo || "-"}</td>
                                              </tr>

                                              <tr>
                                                <th>Financiamiento</th>
                                                <td>${data.nombre_externa || "-"}</td>
                                                <th>Tipo de proyecto</th>
                                                <td>${data.tipo_de_proyecto || "-"}</td>
                                                <th>Tipo de actividad</th>
                                                <td>${data.tipo_de_actividad || "-"}</td>
                                              </tr>

                                              <tr>
                                                <th>√Årea de conocimiento</th>
                                                <td colspan="2">${data.area_de_conocimiento || "-"}</td>
                                                <th>Disciplina</th>
                                                <td colspan="2">${data.disciplina || "-"}</td>
                                              </tr>

                                              <tr>
                                                <th>Objetivo socioecon√≥mico</th>
                                                <td colspan="5">${data.objetivo_socioeconomico || "-"}</td>
                                              </tr>

                                              <tr>
                                                <th>Resoluci√≥n</th>
                                                <td colspan="2">${data.resolucion || "-"}</td>
                                                <th>Expediente</th>
                                                <td colspan="2">${data.expediente || "-"}</td>
                                              </tr>
</table>
                                                                                                                                                                                                                                `;
            } catch (error) {
                console.error("Error al obtener el proyecto:", error);
                contenido.innerHTML = "<p style='color: red;'>Error al obtener el proyecto.</p>";
            }
        }
    </script>
    <script>
        function logout() {
            firebase.auth().signOut().then(() => {
                location.reload(); // opcional, o simplemente ocult√°s interfaz y mostr√°s login
            });
        }
    </script>
    <script>
        let ordenAscendente = [];

        function ordenarTabla(columna, th) {
            const tabla = document.getElementById("tabla-proyectos");
            const cuerpo = tabla.tBodies[0];
            const filas = Array.from(cuerpo.rows);

            // Alternar orden
            if (ordenAscendente[columna] === undefined) {
                ordenAscendente[columna] = true;
            } else {
                ordenAscendente[columna] = !ordenAscendente[columna];
            }

            // Borrar flechas anteriores
            document.querySelectorAll(".tabla-proyectos th .flecha").forEach(f => f.textContent = "");

            // Insertar flecha actual
            th.querySelector(".flecha").textContent = ordenAscendente[columna] ? " üîº" : " üîΩ";

            // Ordenar filas
            filas.sort((a, b) => {
                let valA = a.cells[columna].textContent.trim().toLowerCase();
                let valB = b.cells[columna].textContent.trim().toLowerCase();

                const numA = parseFloat(valA.replace(/[$.]/g, "").replace(",", "."));
                const numB = parseFloat(valB.replace(/[$.]/g, "").replace(",", "."));

                if (!isNaN(numA) && !isNaN(numB)) {
                    return ordenAscendente[columna] ? numA - numB : numB - numA;
                }

                return ordenAscendente[columna]
                    ? valA.localeCompare(valB)
                    : valB.localeCompare(valA);
            });

            // Aplicar orden al DOM
            cuerpo.innerHTML = "";
            filas.forEach(fila => cuerpo.appendChild(fila));
        }
    </script>
    <script>
        async function abrirRendicionFinanciera(projectId) {
            const contenido = document.querySelector(".contenido-principal");

            try {
                const doc = await firebase.firestore().collection("proyectos").doc(projectId).get();
                if (!doc.exists) {
                    contenido.innerHTML = "<p style='color: red;'>Proyecto no encontrado.</p>";
                    return;
                }

                const data = doc.data();
                const codigo = data.Codigo || "SIN C√ìDIGO";
                const presupuestoTotal = parseFloat(data.monto_total || 0);

                let enviada = false;
                let fechaEnvio = null;

                try {
                    const rendicionSnap = await firebase.firestore().collection("rendiciones").doc(codigo).get();
                    if (rendicionSnap.exists) {
                        const rendicionData = rendicionSnap.data();
                        enviada = rendicionData.enviada || false;
                        fechaEnvio = rendicionData.fecha_envio?.toDate().toLocaleDateString('es-AR') || null;
                    }
                } catch (error) {
                    console.warn("No se pudo leer el estado de la rendici√≥n:", error);
                }

                contenido.innerHTML = `
                                                                                                                                                                  <h3 style="margin-bottom: 25px;">Rendici√≥n financiera del proyecto <strong>${codigo}</strong></h3>
                                                                                                                                                                  <form id="form-gasto" onsubmit="event.preventDefault(); agregarGasto(${presupuestoTotal}, '${codigo}');" style="display: flex; flex-direction: column; gap: 15px; max-width: 600px;">
                                                                                                                                                                    <div>
                                                                                                                                                                      <label>Rubro:</label>
                                                                                                                                                                      <select id="rubro" required class="form-select" onchange="actualizarBotonesAdjuntos()">
                                                                                                                                                                        <option value="">Seleccione...</option>
                                                                                                                                                                        <option>Viajes y vi√°ticos</option>
                                                                                                                                                                        <option>Equipamiento</option>
                                                                                                                                                                        <option>Licencia</option>
                                                                                                                                                                        <option>Bibliograf√≠a</option>
                                                                                                                                                                        <option>Bienes de consumo</option>
                                                                                                                                                                        <option>Difusi√≥n y/o protecci√≥n de resultados</option>
                                                                                                                                                                        <option>Servicios de terceros</option>
                                                                                                                                                                      </select>
                                                                                                                                                                    </div>
                                                                                                                                                                    <div>
                                                                                                                                                                      <label>Concepto (m√°x. 40 caracteres):</label>
                                                                                                                                                                      <textarea id="concepto" maxlength="40" required rows="2" class="form-textarea"></textarea>
                                                                                                                                                                      <div id="contador-concepto" style="font-size: 12px; text-align: right; color: gray;">0 / 40</div>
                                                                                                                                                                    </div>
                                                                                                                                                                    <div>
                                                                                                                                                                      <label>Tipo de comprobante:</label>
                                                                                                                                                                      <select id="tipo-comprobante" required class="form-select" onchange="actualizarBotonesAdjuntos()">
                                                                                                                                                                        <option value="">Seleccione...</option>
                                                                                                                                                                        <option>Ticket fiscal</option>
                                                                                                                                                                        <option>Factura B o C</option>
                                                                                                                                                                        <option>Sube o taxi</option>
                                                                                                                                                                        <option>Moneda extranjera</option>
                                                                                                                                                                      </select>
                                                                                                                                                                    </div>
                                                                                                                                                                    <div>
                                                                                                                                                                      <label>CUIT del proveedor:</label>
                                                                                                                                                                      <input type="text" id="cuit" required pattern="\\d{11}" placeholder="Solo n√∫meros (11)" class="form-input">
                                                                                                                                                                    </div>
                                                                                                                                                                    <div>
                                                                                                                                                                      <label>N¬∫ de comprobante:</label>
                                                                                                                                                                      <input type="text" id="comprobante" required pattern="\\d{5}-\\d{8}" placeholder="Ej: 12345-56789012" class="form-input">
                                                                                                                                                                    </div>
                                                                                                                                                                    <div>
                                                                                                                                                                      <label>Fecha del comprobante:</label>
                                                                                                                                                                      <input type="date" id="fecha" required class="form-input">
                                                                                                                                                                    </div>
                                                                                                                                                                    <div id="div-monto-pesos">
                                                                                                                                                                      <label>Importe en pesos:</label>
                                                                                                                                                                      <input type="number" id="importe" required step="0.01" min="0" class="form-input" oninput="actualizarBotonesAdjuntos()">
                                                                                                                                                                    </div>
                                                                                                                                                                    <div id="div-monto-dolares" style="display:none;">
                                                                                                                                                                      <label>Importe en d√≥lares:</label>
                                                                                                                                                                      <input type="number" id="monto-dolares" step="0.01" min="0" class="form-input">
                                                                                                                                                                    </div>
                                                                                                                                                                    <div id="div-tipo-cambio" style="display:none;">
                                                                                                                                                                      <label>Tipo de cambio (en pesos):</label>
                                                                                                                                                                      <input type="number" id="tipo-cambio" step="0.01" min="0" class="form-input">
                                                                                                                                                                    </div>
                                                                                                                                                                    <div id="adjuntos-container" style="margin-top: 20px;"></div>
                                                                                                                                                                  <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="submit" class="form-button" id="btn-submit-gasto">Agregar gasto</button>
                        <button type="button" class="form-button" id="btn-cancelar-edicion" style="background-color: gray; display: none;" onclick="cancelarEdicion()">Cancelar edici√≥n</button>
</div>
                                                                                                                                                                  </form>
                                                                                                                                                                  <div style="display: flex; gap: 20px; margin-top: 20px;">
                                                                                                                                                                    <div id="presupuesto-info" class="info-box">Presupuesto total: <strong>$${presupuestoTotal.toLocaleString('es-AR')}</strong></div>
                                                                                                                                                                    <div id="gastado-info" class="info-box">Total gastado: <strong>$0</strong></div>
                                                                                                                                                                    <div id="ejecucion-info" class="info-box" style="flex:1">
                                                                                                                                                                      Ejecuci√≥n: <strong>0%</strong>
                                                                                                                                                                      <div style="width: 100%; background: #eee; height: 10px; border-radius: 5px; margin-top: 4px;">
                                                                                                                                                                        <div id="barra-ejecucion" style="width: 0%; height: 10px; background: green; border-radius: 5px;"></div>
                                                                                                                                                                      </div>
                                                                                                                                                                    </div>
                                                                                                                                                                  </div>
                                                                                                                                                                  <table class="tabla-proyectos" id="tabla-gastos" style="margin-top: 40px;">
                                                                                                                                                                    <thead>
                                                                                                                                                                      <tr>
                                                                                                                                                                        <th>Rubro</th>
                                                                                                                                                                        <th>Concepto</th>
                                                                                                                                                                        <th>Tipo</th>
                                                                                                                                                                        <th>CUIT</th>
                                                                                                                                                                        <th>Comprobante</th>
                                                                                                                                                                        <th>Fecha</th>
                                                                                                                                                                        <th>Importe</th>
                                                                                                                                                                        <th>Adjuntos</th>
                                                                                                                                                                        <th>Acciones</th>
                                                                                                                                                                      </tr>
                                                                                                                                                                    </thead>
                                                                                                                                                                    <tbody></tbody>
                                                                                                                                                                  </table>
                                                                                                                                                                  <div style="margin-top: 30px; text-align: right;">

                                                                                                                                                          <button id="btn-enviar-rendicion" class="form-button" onclick="codigoProyectoActual='${codigo}'; presupuestoProyectoActual=${presupuestoTotal}; mostrarModalConfirmacion()">Enviar rendici√≥n</button>
</div>
<div id="info-envio" style="margin-top: 15px; color: green; font-weight: bold;"></div>
                                                                                                                                                                `;

                document.getElementById("concepto").addEventListener("input", () => {
                    const texto = document.getElementById("concepto").value.length;
                    document.getElementById("contador-concepto").textContent = `${texto} / 40`;
                });
                if (enviada) {
                    document.getElementById("form-gasto").style.display = "none";
                    document.getElementById("btn-enviar-rendicion").disabled = true;
                    document.getElementById("info-envio").innerHTML = `
                            Rendici√≥n enviada el ${fechaEnvio}.
                            <button onclick="generarPDF('${codigo}', ${presupuestoTotal})" class="form-button" style="margin-left: 10px; padding: 4px 10px; font-size: 13px;">
                                Descargar PDF nuevamente
                            </button>
                        `;

                    // Limpia todas las celdas de acciones
                    const filas = document.querySelectorAll("#tabla-gastos tbody tr");
                    filas.forEach(fila => {
                        const celdaAcciones = fila.querySelector("td:last-child");
                        if (celdaAcciones) celdaAcciones.innerHTML = "";
                    });
                }

                // Cargar los gastos guardados
                try {
                    const gastosSnap = await firebase.firestore()
                        .collection("rendiciones")
                        .doc(codigo)
                        .collection("gastos")
                        .get();

                    const tbody = document.querySelector("#tabla-gastos tbody");
                    tbody.innerHTML = "";

                    gastosSnap.forEach(doc => {
                        const gasto = doc.data();
                        const archivosHtml = gasto.archivos
                            ? Object.values(gasto.archivos)
                                .map(url => `<a href="${url}" target="_blank" title="Ver archivo">üìé</a>`)
                                .join(" ")
                            : "";

                        const fila = document.createElement("tr");
                        fila.setAttribute("data-id", doc.id);
                        fila.innerHTML = `
                        <td>${gasto.rubro || ''}</td>
                        <td>${gasto.concepto || ''}</td>
                        <td>${gasto.tipo || ''}</td>
                        <td>${gasto.cuit || ''}</td>
                        <td>${gasto.comprobante || ''}</td>
                        <td>${gasto.fecha || ''}</td>
                        <td class="importe">$${Number(gasto.importe).toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td>${archivosHtml}</td>
                        <td style="text-align:center;">
                            <span onclick="editarGasto('${codigo}', '${doc.id}')" style="cursor:pointer; color:blue; margin-right: 8px;">‚úé</span>
                            <span onclick="eliminarGasto('${codigo}', '${doc.id}', this, ${presupuestoTotal})" style="cursor:pointer; color:red;">‚úñ</span>
                        </td>
`;

                        tbody.appendChild(fila);
                    });

                    actualizarTotales(presupuestoTotal);
                } catch (error) {
                    console.error("Error al cargar gastos guardados:", error);
                    contenido.innerHTML += "<p style='color: red;'>No se pudieron cargar los gastos guardados.</p>";
                }

            } catch (error) {
                console.error("Error al abrir Rendici√≥n financiera:", error);
                contenido.innerHTML = "<p style='color: red;'>Error al abrir Rendici√≥n financiera.</p>";
            }
        }
        function actualizarResumenFinanciero(nuevoGasto) {
            if (!window.totalGastado) window.totalGastado = 0;
            window.totalGastado += nuevoGasto;
            const porcentaje = ((window.totalGastado / window.totalPresupuesto) * 100).toFixed(1);

            document.getElementById("monto-presupuesto").textContent = `$${window.totalPresupuesto.toLocaleString('es-AR')}`;
            document.getElementById("monto-gastado").textContent = `$${window.totalGastado.toLocaleString('es-AR')}`;
            document.getElementById("porcentaje-ejecucion").textContent = `${porcentaje}%`;
            document.getElementById("barra-ejecucion").style.width = `${porcentaje}%`;
        }
        function crearCampoArchivo(id, label) {
            return `
                                                                                                                                                                                                    <div class="campo-archivo">
                                                                                                                                                                                                      <label>${label}</label>
                                                                                                                                                                                                      <input type="file" id="${id}" accept=".pdf" class="form-input" />
                                                                                                                                                                                                    </div>`;
        }

        function actualizarBotonesAdjuntos() {
            const tipo = document.getElementById("tipo-comprobante").value;
            const importe = parseFloat(document.getElementById("importe").value);
            const adjuntos = document.getElementById("adjuntos-container");
            const cuit = document.getElementById("cuit");
            const comprobante = document.getElementById("comprobante");
            const divPesos = document.getElementById("div-monto-pesos");
            const campoPesos = document.getElementById("importe");
            const divDolares = document.getElementById("div-monto-dolares");
            const campoDolares = document.getElementById("monto-dolares");
            const divCambio = document.getElementById("div-tipo-cambio");
            const campoCambio = document.getElementById("tipo-cambio");

            adjuntos.innerHTML = "";

            cuit.disabled = false;
            comprobante.disabled = false;
            divPesos.style.display = "block";
            campoPesos.required = true;
            divDolares.style.display = "none";
            divCambio.style.display = "none";
            campoDolares.required = false;
            campoCambio.required = false;

            if (tipo === "Ticket fiscal") {
                adjuntos.innerHTML += crearCampoArchivo("archivo_ticket", "Adjuntar ticket fiscal");
            } else if (tipo === "Factura B o C") {
                adjuntos.innerHTML += crearCampoArchivo("archivo_factura", "Adjuntar factura");
                adjuntos.innerHTML += crearCampoArchivo("archivo_cae", "Adjuntar comprobante CAE");
                adjuntos.innerHTML += crearCampoArchivo("archivo_afip", "Adjuntar constancia AFIP");
            } else if (tipo === "Sube o taxi") {
                cuit.disabled = true;
                comprobante.disabled = true;
                adjuntos.innerHTML += crearCampoArchivo("archivo_transporte", "Adjuntar comprobante Sube o taxi");
            } else if (tipo === "Moneda extranjera") {
                cuit.disabled = true;
                comprobante.disabled = true;
                divPesos.style.display = "none";
                campoPesos.required = false;
                divDolares.style.display = "block";
                campoDolares.required = true;
                divCambio.style.display = "block";
                campoCambio.required = true;

                adjuntos.innerHTML += crearCampoArchivo("archivo_factura_ext", "Adjuntar factura extranjera");
                adjuntos.innerHTML += crearCampoArchivo("archivo_cambio", "Adjuntar comprobante tipo de cambio");
                adjuntos.innerHTML += crearCampoArchivo("archivo_otros", "Otros documentos (opcional)");
            }

            if (!isNaN(importe) && importe > 3000 && tipo !== "Sube o taxi" && tipo !== "Moneda extranjera") {
                adjuntos.innerHTML += crearCampoArchivo("archivo_bancario", "Adjuntar comprobante bancario (> $3000)");
            }
        }

        async function agregarGasto(presupuestoTotal, codigo) {
            const rubro = document.getElementById("rubro").value;
            const concepto = document.getElementById("concepto").value;
            const tipo = document.getElementById("tipo-comprobante").value;
            const fecha = document.getElementById("fecha").value;

            const cuit = document.getElementById("cuit").value;
            const comprobante = document.getElementById("comprobante").value;

            const importePesos = parseFloat(document.getElementById("importe")?.value || "NaN");
            const montoDolares = parseFloat(document.getElementById("monto-dolares")?.value || "NaN");
            const tipoCambio = parseFloat(document.getElementById("tipo-cambio")?.value || "NaN");

            let importeFinal;

            // Validaci√≥n condicional seg√∫n tipo
            if (tipo === "Moneda extranjera") {
                if (!rubro || !concepto || !tipo || !fecha || isNaN(montoDolares) || isNaN(tipoCambio)) {
                    alert("Por favor, complet√° todos los campos obligatorios correctamente.");
                    return;
                }
                importeFinal = montoDolares * tipoCambio;
            } else if (tipo === "Sube o taxi") {
                if (!rubro || !concepto || !tipo || !fecha || isNaN(importePesos)) {
                    alert("Por favor, complet√° todos los campos obligatorios correctamente.");
                    return;
                }
                importeFinal = importePesos;
            } else {
                if (!rubro || !concepto || !tipo || !cuit || !comprobante || !fecha || isNaN(importePesos)) {
                    alert("Por favor, complet√° todos los campos obligatorios correctamente.");
                    return;
                }
                importeFinal = importePesos;
            }

            mostrarProcesando(true);

            try {
                const inputsFile = document.querySelectorAll('#adjuntos-container input[type="file"]');
                const archivos = {};

                for (const input of inputsFile) {
                    const file = input.files[0];
                    const nombreCampo = input.previousElementSibling.textContent;

                    if (!file) {
                        alert(`Falta adjuntar: ${nombreCampo}`);
                        ocultarProcesando();
                        return;
                    }

                    const fileName = `${Date.now()}_${file.name}`;
                    const ref = firebase.storage().ref().child(`gastos/${codigo}/${fileName}`);
                    await ref.put(file);
                    const url = await ref.getDownloadURL();
                    archivos[nombreCampo] = url;
                }

                const gasto = {
                    rubro,
                    concepto,
                    tipo,
                    cuit: (tipo === "Moneda extranjera" || tipo === "Sube o taxi") ? "" : cuit,
                    comprobante: (tipo === "Moneda extranjera" || tipo === "Sube o taxi") ? "" : comprobante,
                    fecha,
                    importe: importeFinal,
                    archivos
                };

                const docRef = firebase.firestore().collection("rendiciones").doc(codigo);
                const gastosRef = docRef.collection("gastos");
                const nuevoGasto = await gastosRef.add(gasto);

                const archivosHtml = Object.values(archivos)
                    .map(url => `<a href="${url}" target="_blank" title="Ver archivo">üìé</a>`)
                    .join(" ");

                const tbody = document.querySelector("#tabla-gastos tbody");
                const fila = document.createElement("tr");
                fila.setAttribute("data-id", nuevoGasto.id);
                fila.innerHTML = `
                                                                                                                                                                        <td>${rubro}</td>
                                                                                                                                                                        <td>${concepto}</td>
                                                                                                                                                                        <td>${tipo}</td>
                                                                                                                                                                        <td>${(tipo === "Moneda extranjera" || tipo === "Sube o taxi") ? "-" : cuit}</td>
                                                                                                                                                                        <td>${(tipo === "Moneda extranjera" || tipo === "Sube o taxi") ? "-" : comprobante}</td>
                                                                                                                                                                        <td>${fecha}</td>
                                                                                                                                                                        <td class="importe">$${importeFinal.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                                                                                                                                                        <td>${archivosHtml}</td>
                                                                                                                                                                        <td style="text-align:center;">
                                                                                                                                                                          <span onclick="editarGasto('${codigo}', '${nuevoGasto.id}')" style="cursor:pointer; color:blue; margin-right: 8px;">‚úé</span>
<span onclick="eliminarGasto('${codigo}', '${nuevoGasto.id}', this, ${presupuestoTotal})" style="cursor:pointer; color:red;">‚úñ</span>
                                                                                                                                                                        </td>
                                                                                                                                                                    `;
                tbody.appendChild(fila);

                document.getElementById("form-gasto").reset();
                document.getElementById("adjuntos-container").innerHTML = "";
                document.getElementById("contador-concepto").textContent = "0 / 40";
                actualizarTotales(presupuestoTotal);
            } catch (error) {
                console.error("Error al guardar gasto:", error);
                alert("Ocurri√≥ un error al guardar el gasto.");
            }

            ocultarProcesando();
        }

        async function eliminarGasto(codigo, gastoId, boton, presupuestoTotal) {
            // üîê Verificar si la rendici√≥n ya fue enviada
            try {
                const rendicionDoc = await firebase.firestore().collection("rendiciones").doc(codigo).get();
                if (rendicionDoc.exists && rendicionDoc.data().enviada === true) {
                    alert("La rendici√≥n ya fue enviada. No se pueden eliminar gastos.");
                    return;
                }
            } catch (e) {
                console.error("Error al verificar estado de la rendici√≥n:", e);
                alert("Error al verificar el estado de la rendici√≥n. Intente nuevamente.");
                return;
            }

            if (!confirm("¬øEst√°s seguro que quer√©s eliminar este gasto?")) return;

            mostrarProcesando(true); // ‚¨ÖÔ∏è Mostrar cartel "Procesando..."

            try {
                const docRef = firebase.firestore().collection("rendiciones").doc(codigo).collection("gastos").doc(gastoId);
                const doc = await docRef.get();

                if (doc.exists) {
                    const data = doc.data();
                    const archivos = data.archivos || {};

                    for (const nombre in archivos) {
                        const url = archivos[nombre];
                        try {
                            const path = decodeURIComponent(new URL(url).pathname.split("/o/")[1]).split("?")[0];
                            await firebase.storage().ref().child(path).delete();
                        } catch (e) {
                            console.warn(`No se pudo eliminar el archivo ${nombre}:`, e);
                        }
                    }

                    await docRef.delete();

                    const fila = boton.closest("tr");
                    fila.remove();

                    actualizarTotales(presupuestoTotal);
                }
            } catch (error) {
                console.error("Error al eliminar gasto:", error);
                alert("No se pudo eliminar el gasto.");
            }

            ocultarProcesando(); // ‚¨ÖÔ∏è Ocultar cartel "Procesando..."
        }

        let idGastoEditando = null;

        async function editarGasto(codigo, gastoId) {
            try {
                // üîê Verificar si la rendici√≥n ya fue enviada
                const rendicionDoc = await firebase.firestore().collection("rendiciones").doc(codigo).get();
                if (rendicionDoc.exists && rendicionDoc.data().enviada === true) {
                    alert("La rendici√≥n ya fue enviada. No se pueden editar gastos.");
                    return;
                }

                const docRef = firebase.firestore().collection("rendiciones").doc(codigo).collection("gastos").doc(gastoId);
                const doc = await docRef.get();

                if (!doc.exists) {
                    alert("Gasto no encontrado.");
                    return;
                }

                const gasto = doc.data();
                idGastoEditando = gastoId;

                document.getElementById("rubro").value = gasto.rubro || "";
                document.getElementById("concepto").value = gasto.concepto || "";
                document.getElementById("tipo-comprobante").value = gasto.tipo || "";
                document.getElementById("fecha").value = gasto.fecha || "";

                if (gasto.tipo === "Moneda extranjera") {
                    const tipoCambio = parseFloat(gasto.tipo_cambio || "1") || 1;
                    const montoDolares = gasto.importe / tipoCambio;
                    document.getElementById("monto-dolares").value = montoDolares.toFixed(2);
                    document.getElementById("tipo-cambio").value = tipoCambio;
                } else {
                    document.getElementById("importe").value = gasto.importe || "";
                }

                if (gasto.tipo !== "Moneda extranjera" && gasto.tipo !== "Sube o taxi") {
                    document.getElementById("cuit").value = gasto.cuit || "";
                    document.getElementById("comprobante").value = gasto.comprobante || "";
                }

                actualizarBotonesAdjuntos();

                // Cambiar texto y funci√≥n del bot√≥n
                const form = document.getElementById("form-gasto");
                const boton = form.querySelector("button[type='submit']");
                boton.textContent = "Actualizar gasto";
                form.onsubmit = function (e) {
                    e.preventDefault();
                    actualizarGasto(codigo, idGastoEditando);
                };

                document.getElementById("btn-cancelar-edicion").style.display = "inline-block";
                window.scrollTo({ top: form.offsetTop - 80, behavior: 'smooth' });

            } catch (error) {
                console.error("Error al editar gasto:", error);
                alert("Error al cargar el gasto para edici√≥n.");
            }
        }
        function cancelarEdicion() {
            const form = document.getElementById("form-gasto");
            form.reset();
            document.getElementById("adjuntos-container").innerHTML = "";
            document.getElementById("contador-concepto").textContent = "0 / 40";
            document.getElementById("btn-submit-gasto").textContent = "Agregar gasto";
            document.getElementById("btn-cancelar-edicion").style.display = "none";

            form.onsubmit = function (e) {
                e.preventDefault();
                agregarGasto(presupuestoProyectoActual, codigoProyectoActual);
            };
        }
        async function actualizarGasto(codigo, gastoId) {
            const rubro = document.getElementById("rubro").value;
            const concepto = document.getElementById("concepto").value;
            const tipo = document.getElementById("tipo-comprobante").value;
            const fecha = document.getElementById("fecha").value;

            const cuit = document.getElementById("cuit").value;
            const comprobante = document.getElementById("comprobante").value;

            const importePesos = parseFloat(document.getElementById("importe")?.value || "NaN");
            const montoDolares = parseFloat(document.getElementById("monto-dolares")?.value || "NaN");
            const tipoCambio = parseFloat(document.getElementById("tipo-cambio")?.value || "NaN");

            let importeFinal;
            if (tipo === "Moneda extranjera") {
                if (!rubro || !concepto || !tipo || !fecha || isNaN(montoDolares) || isNaN(tipoCambio)) {
                    alert("Complet√° todos los campos requeridos.");
                    return;
                }
                importeFinal = montoDolares * tipoCambio;
            } else if (tipo === "Sube o taxi") {
                if (!rubro || !concepto || !tipo || !fecha || isNaN(importePesos)) {
                    alert("Complet√° todos los campos requeridos.");
                    return;
                }
                importeFinal = importePesos;
            } else {
                if (!rubro || !concepto || !tipo || !cuit || !comprobante || !fecha || isNaN(importePesos)) {
                    alert("Complet√° todos los campos requeridos.");
                    return;
                }
                importeFinal = importePesos;
            }

            mostrarProcesando(true);

            try {
                const docRef = firebase.firestore().collection("rendiciones").doc(codigo).collection("gastos").doc(gastoId);
                const docSnap = await docRef.get();

                if (!docSnap.exists) {
                    alert("Gasto no encontrado.");
                    ocultarProcesando();
                    return;
                }

                const gastoActual = docSnap.data();
                const archivosAntiguos = gastoActual.archivos || {};
                const archivosActualizados = {};

                const inputsFile = document.querySelectorAll('#adjuntos-container input[type="file"]');

                for (const input of inputsFile) {
                    const nombreCampo = input.previousElementSibling.textContent;

                    if (input.files.length > 0) {
                        if (archivosAntiguos[nombreCampo]) {
                            const urlAntiguo = archivosAntiguos[nombreCampo];
                            const path = decodeURIComponent(new URL(urlAntiguo).pathname.split("/o/")[1]).split("?")[0];
                            try {
                                await firebase.storage().ref().child(path).delete();
                            } catch (e) {
                                console.warn(`No se pudo eliminar el archivo anterior "${nombreCampo}":`, e);
                            }
                        }

                        const file = input.files[0];
                        const fileName = `${Date.now()}_${file.name}`;
                        const ref = firebase.storage().ref().child(`gastos/${codigo}/${fileName}`);
                        await ref.put(file);
                        const url = await ref.getDownloadURL();
                        archivosActualizados[nombreCampo] = url;
                    } else if (archivosAntiguos[nombreCampo]) {
                        archivosActualizados[nombreCampo] = archivosAntiguos[nombreCampo];
                    }
                }

                await docRef.update({
                    rubro,
                    concepto,
                    tipo,
                    cuit: (tipo === "Moneda extranjera" || tipo === "Sube o taxi") ? "" : cuit,
                    comprobante: (tipo === "Moneda extranjera" || tipo === "Sube o taxi") ? "" : comprobante,
                    fecha,
                    importe: importeFinal,
                    archivos: archivosActualizados
                });

                alert("Gasto actualizado correctamente.");
                cancelarEdicion();
                abrirRendicionFinanciera(codigo);

            } catch (error) {
                console.error("Error al actualizar gasto:", error);
                alert("Ocurri√≥ un error al guardar el gasto.");
            }

            ocultarProcesando();
        }

        function actualizarTotales(presupuestoTotal) {
            const importes = Array.from(document.querySelectorAll(".importe"))
                .map(td => parseFloat(
                    td.textContent
                        .replace(/\./g, '')    // quitar puntos de miles
                        .replace(',', '.')     // reemplazar coma decimal por punto
                        .replace(/[^\d.-]/g, '') // eliminar s√≠mbolos como $
                ));

            const totalGastado = importes.reduce((a, b) => a + b, 0);
            const porcentaje = (totalGastado / presupuestoTotal) * 100;

            // Actualizar total gastado
            document.getElementById("gastado-info").innerHTML = `Total gastado: <strong>$${totalGastado.toLocaleString('es-AR')}</strong>`;

            // Actualizar porcentaje textual
            const porcentajeTexto = porcentaje > 100
                ? `100% <span style="color: red; font-weight: bold;">(Sobre ejecuci√≥n: +${(porcentaje - 100).toFixed(1)}%)</span>`
                : `${porcentaje.toFixed(1)}%`;
            document.querySelector("#ejecucion-info strong").innerHTML = porcentajeTexto;

            // Actualizar barra de ejecuci√≥n
            const barra = document.getElementById("barra-ejecucion");
            barra.style.width = `${Math.min(porcentaje, 100)}%`;
            barra.style.background = porcentaje >= 100 ? "#28a745" : "#f0ad4e";
        }
    </script>
    <script>
        function mostrarProcesando() {
            const modal = document.getElementById("modal-procesando");
            modal.style.display = "flex";
        }

        function ocultarProcesando() {
            const modal = document.getElementById("modal-procesando");
            modal.style.display = "none";
        }
    </script>
    <script>
        async function enviarRendicion(codigo, presupuestoTotal) {
            mostrarProcesando();

            const fechaEnvio = new Date().toLocaleDateString('es-AR');

            try {
                await firebase.firestore().collection("rendiciones").doc(codigo).set({
                    enviada: true,
                    fecha_envio: firebase.firestore.Timestamp.now()
                }, { merge: true });

                document.getElementById("form-gasto").style.display = "none";
                document.querySelectorAll("#tabla-gastos .importe").forEach(td => td.parentElement.querySelector("span").remove());
                document.getElementById("btn-enviar-rendicion").disabled = true;
                document.getElementById("info-envio").innerHTML = `
                                                                                                                                  Rendici√≥n enviada el ${fechaEnvio}.
                                                                                                                                  <button onclick="generarPDF('${codigo}', ${presupuestoTotal})" class="form-button" style="margin-left: 10px; padding: 4px 10px; font-size: 13px;">
                                                                                                                                    Descargar PDF nuevamente
                                                                                                                                  </button>
`;

                await generarPDF(codigo, presupuestoTotal);

            } catch (error) {
                alert("Error al enviar rendici√≥n.");
                console.error(error);
            }

            ocultarProcesando();
        }
    </script>
    <script>
        async function generarPDF(codigo, presupuestoTotal) {
            const doc = new jspdf.jsPDF();

            const proyectoDoc = await firebase.firestore().collection("proyectos").where("Codigo", "==", codigo).limit(1).get();
            const data = proyectoDoc.docs[0].data();

            const gastosSnapshot = await firebase.firestore()
                .collection("rendiciones")
                .doc(codigo)
                .collection("gastos")
                .get();

            const rows = [];
            let total = 0;

            gastosSnapshot.forEach(doc => {
                const d = doc.data();
                total += d.importe;
                rows.push([
                    d.rubro, d.concepto, d.tipo,
                    d.cuit || "-", d.comprobante || "-", d.fecha,
                    `$${d.importe.toFixed(2)}`
                ]);
            });

            // Cargar logo
            const logoImg = new Image();
            logoImg.src = "https://i.postimg.cc/4dx5PqYF/Captura-de-pantalla-2025-05-03-091928.png";

            logoImg.onload = function () {
                doc.addImage(logoImg, 'PNG', 14, 10, 30, 15); // logo (x, y, width, height)

                doc.setFontSize(12);
                doc.text("Sistema integral para ejecuci√≥n de proyectos I+D (SIEP-UNTREF)", 50, 18);
                doc.setFontSize(10);
                doc.text("Secretar√≠a de Investigaci√≥n y Desarrollo", 50, 24);

                let y = 35;
                doc.setFontSize(12);
                doc.text(`Rendici√≥n Financiera del Proyecto ${codigo}`, 14, y);
                doc.setFontSize(10);
                doc.text(`T√≠tulo: ${data.titulo || "-"}`, 14, y + 10);
                doc.text(`Convocatoria: ${data.convocatoria || "-"}`, 14, y + 15);
                doc.text(`Presupuesto Total: $${presupuestoTotal.toLocaleString('es-AR')}`, 14, y + 20);
                doc.text(`Total Gastado: $${total.toLocaleString('es-AR')}`, 14, y + 25);

                doc.autoTable({
                    head: [['Rubro', 'Concepto', 'Tipo', 'CUIT', 'Comprobante', 'Fecha', 'Importe']],
                    body: rows,
                    startY: y + 30
                });

                doc.line(14, doc.lastAutoTable.finalY + 30, 76, doc.lastAutoTable.finalY + 30);
                doc.text("Firma, aclaraci√≥n y DNI del responsable", 14, doc.lastAutoTable.finalY + 35);


                doc.save(`Rendicion_${codigo}.pdf`);
            };
        }
    </script>
    <script>
        let codigoProyectoActual = null;
        let presupuestoProyectoActual = 0;

        function mostrarModalConfirmacion() {
            document.getElementById("modal-confirmacion-envio").style.display = "flex";
        }

        function cerrarModalConfirmacion() {
            document.getElementById("modal-confirmacion-envio").style.display = "none";
        }

        function confirmarEnvioRendicion() {
            cerrarModalConfirmacion();
            enviarRendicion(codigoProyectoActual, presupuestoProyectoActual);
        }
    </script>
    <script>
        function abrirInformesAcademicos(codigo) {
            const contenedor = document.querySelector(".contenido-principal");
            if (!contenedor) {
                console.error("No se encontr√≥ el contenedor '.contenido-principal'");
                return;
            }

            contenedor.innerHTML = `
                                                                                                        <h2 style="margin-bottom: 20px;">Informe acad√©mico del proyecto <strong>${codigo}</strong></h2>
                                                                                                        <div style="display: flex; gap: 20px;">
                                                                                                          <button onclick="abrirInformeParcial('${codigo}')" class="form-button">Informe Parcial</button>
                                                                                                          <button onclick="abrirInformeFinal('${codigo}')" class="form-button">Informe Final</button>
                                                                                                        </div>
                                                                                                      `;
        }
    </script>
    <script>
        function abrirInformeParcial(codigo) {
            const contenedor = document.querySelector(".contenido-principal");
            if (!contenedor) return;

            mostrarCargando();

            contenedor.innerHTML = `
                                                                              <h2 style="margin-bottom: 20px;">Informe Parcial del Proyecto <strong>${codigo}</strong></h2>

                                                                              <div style="display: flex; flex-direction: column; gap: 30px; max-width: 700px;">

                                                                                <div>
                                                                                  <p><strong>Avances de resultados y actividades del proyecto en relaci√≥n con el plan de trabajo inicial:</strong></p>
                                                                                  <textarea id="campo1" maxlength="3000" required oninput="actualizarContador('campo1')" style="width: 100%; height: 120px; padding: 8px;"></textarea>
                                                                                  <div id="contador-campo1" style="font-size: 12px; color: gray; text-align: right;">0 / 3000</div>
                                                                                </div>

                                                                                <div>
                                                                                  <p><strong>Problemas y dificultades encontradas, reformulaciones o precisiones en relaci√≥n al proyecto presentado:</strong></p>
                                                                                  <textarea id="campo2" maxlength="3000" required oninput="actualizarContador('campo2')" style="width: 100%; height: 120px; padding: 8px;"></textarea>
                                                                                  <div id="contador-campo2" style="font-size: 12px; color: gray; text-align: right;">0 / 3000</div>
                                                                                </div>

                                                                                <div>
                                                                                  <p><strong>Comentarios o sugerencias:</strong></p>
                                                                                  <textarea id="campo3" maxlength="3000" oninput="actualizarContador('campo3')" style="width: 100%; height: 120px; padding: 8px;"></textarea>
                                                                                  <div id="contador-campo3" style="font-size: 12px; color: gray; text-align: right;">0 / 3000</div>
                                                                                </div>

                                                                                <div id="info-envio-parcial" style="margin-top: 5px; color: green; font-weight: bold;"></div>

                                                                                <div style="display: flex; gap: 20px; margin-top: 10px;">
                                                                                  <button id="btn-guardar-informe" class="form-button" onclick="guardarInformeParcial('${codigo}')">Guardar</button>
                                                                                  <button id="btn-enviar-informe" class="form-button" onclick="mostrarModalConfirmacionParcial()">Enviar informe parcial</button>
                                                                                </div>
                                                                              </div>

                                                                              <div id="modal-confirmacion-parcial" style="
                                                                                display: none;
                                                                                position: fixed;
                                                                                top: 0; left: 0;
                                                                                width: 100%; height: 100%;
                                                                                background: rgba(255, 255, 255, 0.8);
                                                                                z-index: 9999;
                                                                                justify-content: center;
                                                                                align-items: center;
                                                                                font-size: 18px;
                                                                                font-weight: bold;
                                                                                color: #333;
                                                                              ">
                                                                                <div style="background: white; padding: 20px; border: 1px solid #ccc; text-align: center;">
                                                                                  ¬øEst√° seguro de que desea enviar el informe parcial? Luego no podr√° realizar cambios.<br><br>
                                                                                  <button onclick="confirmarEnvioInformeParcial('${codigo}')">S√≠</button>
                                                                                  <button onclick="cerrarModalConfirmacionParcial()">No</button>
                                                                                </div>
                                                                              </div>
`;

            setTimeout(() => {
                cargarInformeParcial(codigo);
            }, 0);
        }

        function actualizarContador(campoId) {
            const campo = document.getElementById(campoId);
            const contador = document.getElementById(`contador-${campoId}`);
            if (campo && contador) {
                contador.textContent = `${campo.value.length} / 3000`;
            }
        }

        function mostrarModalConfirmacionParcial() {
            document.getElementById("modal-confirmacion-parcial").style.display = "flex";
        }

        function cerrarModalConfirmacionParcial() {
            document.getElementById("modal-confirmacion-parcial").style.display = "none";
        }

        function guardarInformeParcial(codigo) {
            const campo1 = document.getElementById("campo1").value.trim();
            const campo2 = document.getElementById("campo2").value.trim();
            const campo3 = document.getElementById("campo3").value.trim();

            if (!campo1 || !campo2) {
                alert("Los primeros dos campos son obligatorios.");
                return;
            }

            firebase.firestore().collection("informes_parciales").doc(codigo).set({
                campo1,
                campo2,
                campo3,
                enviado: false
            }, { merge: true })
                .then(() => {
                    document.getElementById("info-envio-parcial").textContent = "Informe parcial guardado correctamente.";
                })
                .catch(error => {
                    console.error("Error al guardar informe parcial:", error);
                    alert("Error al guardar. Intente nuevamente.");
                });
        }

        function confirmarEnvioInformeParcial(codigo) {
            cerrarModalConfirmacionParcial();
            const fechaEnvio = new Date().toLocaleDateString("es-AR");

            firebase.firestore().collection("informes_parciales").doc(codigo).update({
                enviado: true,
                fechaEnvio
            })
                .then(() => {
                    document.getElementById("campo1").disabled = true;
                    document.getElementById("campo2").disabled = true;
                    document.getElementById("campo3").disabled = true;
                    document.getElementById("btn-guardar-informe").disabled = true;
                    document.getElementById("btn-enviar-informe").disabled = true;
                    document.getElementById("info-envio-parcial").innerHTML = `Informe enviado el <strong>${fechaEnvio}</strong>`;
                })
                .catch(error => {
                    console.error("Error al enviar informe parcial:", error);
                    alert("Error al enviar. Intente nuevamente.");
                });
        }

        async function cargarInformeParcial(codigo) {
            try {
                const docRef = firebase.firestore().collection("informes_parciales").doc(codigo);
                const docSnap = await docRef.get();

                if (docSnap.exists) {
                    const data = docSnap.data();
                    document.getElementById("campo1").value = data.campo1 || "";
                    document.getElementById("campo2").value = data.campo2 || "";
                    document.getElementById("campo3").value = data.campo3 || "";

                    actualizarContador("campo1");
                    actualizarContador("campo2");
                    actualizarContador("campo3");

                    if (data.enviado) {
                        document.getElementById("campo1").disabled = true;
                        document.getElementById("campo2").disabled = true;
                        document.getElementById("campo3").disabled = true;
                        document.getElementById("btn-guardar-informe").disabled = true;
                        document.getElementById("btn-enviar-informe").disabled = true;

                        document.getElementById("info-envio-parcial").innerHTML = `Informe enviado el <strong>${data.fechaEnvio}</strong>`;
                    }
                }
            } catch (error) {
                console.error("Error al cargar informe parcial:", error);
            } finally {
                ocultarCargando();
            }
        }
    </script>
    <script>
        function abrirInformeFinal(codigo) {
            const contenedor = document.querySelector(".contenido-principal");
            if (!contenedor) return;

            mostrarCargando();

            contenedor.innerHTML = `
          <!-- Bot√≥n volver arriba a la derecha -->
          <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
            <button onclick="volverAMisProyectos()" class="btn-volver">‚¨Ö Volver</button>
          </div>

          <h2 style="margin-bottom: 20px;">Informe Final del Proyecto <strong>${codigo}</strong></h2>

          <!-- Botones de pesta√±as -->
          <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: nowrap;">
            <button class="tablink active" onclick="mostrarPestaniaFinal(event, 'cuestionario')">Cuestionario</button>
            <button class="tablink" onclick="mostrarPestaniaFinal(event, 'formacion')">Formaci√≥n de RRHH</button>
            <button class="tablink" onclick="mostrarPestaniaFinal(event, 'produccion')">Producci√≥n cient√≠fica</button>
          </div>

          <!-- Pesta√±a Cuestionario -->
          <div id="tab-cuestionario" class="tabcontent-final">
            <div id="contenido-pestanas-final"></div>
          </div>

          <!-- Pesta√±a Formaci√≥n de RRHH -->
          <div id="tab-formacion" class="tabcontent-final" style="display:none;">
            <form id="form-rrhh" onsubmit="event.preventDefault(); agregarRRHH();" style="max-width: 600px; display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
              <div><label>Nombre:</label><input type="text" id="rrhh-nombre" required class="form-input"></div>
              <div><label>Apellido:</label><input type="text" id="rrhh-apellido" required class="form-input"></div>
              <div><label>CUIT:</label><input type="text" id="rrhh-cuit" required placeholder="11 d√≠gitos" class="form-input" maxlength="11" oninput="this.value = this.value.replace(/[^0-9]/g, '')"></div>
              <div><label>Tipo de formaci√≥n:</label>
                <select id="rrhh-tipo" required class="form-select">
                  <option value="">Seleccione...</option>
                  <option>Posdoctorado</option><option>Tesis doctoral</option><option>Tesis de maestr√≠a</option>
                  <option>Trabajo final de maestr√≠a</option><option>Trabajo final integrador de especializaci√≥n</option>
                  <option>Tesina de grado</option><option>Trabajo final de grado</option><option>Pr√°ctica profesional</option>
                  <option>Cr√©ditos para carrera de grado</option><option>Participaci√≥n en actividades de investigaci√≥n</option>
                </select>
              </div>
              <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="submit" class="form-button" id="btn-agregar-rrhh">Agregar RRHH</button>
                <button type="button" class="form-button" style="background-color: gray; display:none;" id="btn-cancelar-edicion-rrhh" onclick="cancelarEdicionRRHH()">Cancelar edici√≥n</button>
              </div>
            </form>

            <table class="tabla-proyectos" id="tabla-rrhh">
              <thead>
                <tr><th>Nombre</th><th>Apellido</th><th>CUIT</th><th>Tipo</th><th>Acciones</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <!-- Pesta√±a Producci√≥n cient√≠fica -->
          <div id="tab-produccion" class="tabcontent-final" style="display:none;">
            <div id="form-produccion" style="margin-bottom: 20px;">
              <label>Tipo de producci√≥n:</label>
              <select id="tipo-produccion" onchange="mostrarCamposProduccion()" class="form-select">
                <option value="">Seleccione...</option>
                <option>Art√≠culos publicados en revistas</option>
                <option>Libros</option>
                <option>Partes de libros</option>
                <option>Trabajos en eventos cient√≠fico-tecnol√≥gicos publicados</option>
                <option>Tesis e Informes t√©cnicos</option>
                <option>Dem√°s tipos de producci√≥n C-T publicada</option>
              </select>

<div id="campos-articulo" style="display:none; margin-top: 15px;">

<div style="display: flex; gap: 30px; margin-bottom: 20px; flex-wrap: wrap;">

      <!-- Buscar por DOI -->
      <div style="flex: 1; min-width: 220px;">
        <div style="display: flex; align-items: center; gap: 6px;">
          <span onclick="mostrarInfoDOI()" style="cursor: pointer; font-size: 18px;" title="¬øQu√© es esto?">‚ÑπÔ∏è</span>
          <label for="doi-articulo" style="margin: 0;"><strong>Buscar por DOI:</strong></label>
        </div>
        <input type="text" id="doi-articulo" class="form-input" placeholder="Ej: 10.1234/abcd.56789" style="width: 100%; margin-bottom: 6px;">
        <button type="button" onclick="buscarPorDOI()" style="width: 100%;">Buscar DOI</button>
      </div>


<!-- Buscar por ISSN -->
<div style="flex: 1; min-width: 220px;">
  <div style="display: flex; align-items: center; gap: 6px;">
    <span onclick="mostrarInfoISSN()" style="cursor: pointer; font-size: 18px;" title="¬øQu√© es esto?">‚ÑπÔ∏è</span>
    <label for="buscar-issn" style="margin: 0;"><strong>Buscar por ISSN:</strong></label>
  </div>
  <input type="text" id="buscar-issn" class="form-input" placeholder="Ej: 1234-5678" style="width: 100%; margin-bottom: 6px;">
  <button type="button" onclick="buscarPorISSN()" style="width: 100%;">Buscar ISSN</button>
</div>

</div>

          <!-- Campos principales -->
          <div style="display: grid; grid-template-columns: 1fr; gap: 10px;">
            <div>
              <label>T√≠tulo:</label>
              <input type="text" id="titulo-articulo" class="form-input">
            </div>
            <div>
              <label>Autores:</label>
              <input type="text" id="autores-articulo" class="form-input">
            </div>
          </div>

          <!-- Campos secundarios -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
            <div>
              <label>Revista:</label>
              <input type="text" id="revista-articulo" class="form-input">
            </div>
            <div>
              <label>Editorial:</label>
              <input type="text" id="editorial-articulo" class="form-input">
            </div>
<div>
          <label>ISSN:</label>
          <input type="text" id="issn-articulo" class="form-input" readonly>
</div>
            <div>
              <label>A√±o:</label>
              <input type="text" id="anio-articulo" class="form-input">
            </div>
            <div>
              <label>Volumen:</label>
              <input type="text" id="volumen-articulo" class="form-input">
            </div>
            <div>
              <label>N√∫mero:</label>
              <input type="text" id="numero-articulo" class="form-input">
            </div>
            <div>
              <label>P√°ginas:</label>
              <input type="text" id="paginas-articulo" class="form-input">
            </div>
            <div style="grid-column: span 2;">
              <label>URL del art√≠culo:</label>
              <input type="text" id="url-articulo" class="form-input">
            </div>
          </div>

</div>


          <!-- √Årea de botones comunes -->
          <div style="display: flex; gap: 20px; margin-top: 25px;">
            <button id="btn-guardar-informe-final" class="form-button" onclick="guardarInformeFinal('${codigo}')">Guardar</button>
            <button id="btn-enviar-informe-final" class="form-button" onclick="mostrarModalConfirmacionFinal()">Enviar informe final</button>
          </div>

          <!-- Modal de confirmaci√≥n -->
          <div id="modal-confirmacion-final" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); z-index: 9999; justify-content: center; align-items: center; font-size: 18px; font-weight: bold; color: #333;">
            <div style="background: white; padding: 20px; border: 1px solid #ccc; text-align: center;">
              ¬øEst√° seguro de que desea enviar el informe final? Luego no podr√° realizar cambios.<br><br>
              <button onclick="confirmarEnvioInformeFinal('${codigo}')">S√≠</button>
              <button onclick="cerrarModalConfirmacionFinal()">No</button>
            </div>
          </div>
`;





            mostrarPestanaCuestionarioFinal(codigo);
            cargarRRHHFinal(codigo);
            ocultarCargando();
        }
    </script>
    <script>
        function mostrarCargando() {
            document.getElementById("modal-cargando").style.display = "flex";
        }

        function ocultarCargando() {
            document.getElementById("modal-cargando").style.display = "none";
        }
    </script>
    <script>
        function mostrarPestaniaFinal(event, tab) {
            document.querySelectorAll('.tabcontent-final').forEach(div => div.style.display = 'none');
            document.querySelectorAll('.tablink').forEach(btn => btn.classList.remove('active'));

            const tabElement = document.getElementById(`tab-${tab}`);
            tabElement.style.display = 'block';
            event.target.classList.add('active');

            // Cargar contenido din√°mico solo si es necesario
            const codigo = document.querySelector("h2 strong").textContent; // obtiene el c√≥digo del proyecto
            if (tab === 'cuestionario') {
                mostrarPestanaCuestionarioFinal(codigo);
            }
        }
    </script>
    <script>
        // Contenido para la pesta√±a "Cuestionario" del informe final
        function mostrarPestanaCuestionarioFinal(codigo) {
            const contenedor = document.getElementById("contenido-pestanas-final");
            if (!contenedor) return;

            contenedor.innerHTML = `
                                                        <div style="display: flex; flex-direction: column; gap: 25px; max-width: 800px;">
                                                            <div>
                                                                <label for="final-descripcion"><strong>DESCRIPCI√ìN FINAL DEL PROYECTO</strong></label>
                                                                <div style="font-size: 13px; margin-bottom: 6px;">
                                                                    Realice una exposici√≥n sint√©tica de la labor desarrollada durante la ejecuci√≥n del proyecto.
                                                                </div>
                                                                <textarea id="final-descripcion" maxlength="3200" required oninput="actualizarContadorFinal(this)" style="width: 100%; height: 120px; padding: 8px;"></textarea>
                                                                  <div class="contador" id="contador-final-descripcion">0 / 3200</div>
                                                            </div>

                                                            <div>
                                                                <label for="final-obstaculos"><strong>OBST√ÅCULOS Y DIFICULTADES</strong></label>
                                                                <div style="font-size: 13px; margin-bottom: 6px;">
                                                                    Indique los obst√°culos, dificultades, reformulaciones o precisiones realizadas en relaci√≥n al proyecto presentado.
                                                                </div>
                                                                <textarea id="final-obstaculos" maxlength="3200" required oninput="actualizarContadorFinal(this)" style="width: 100%; height: 120px; padding: 8px;"></textarea>
                                                                <div class="contador" id="contador-final-obstaculos">0 / 3200</div>
                                                            </div>

                                                            <div>
                                                                <label for="final-productos"><strong>PRODUCTOS, RESULTADOS Y PRINCIPALES ACTIVIDADES</strong></label>
                                                                <div style="font-size: 13px; margin-bottom: 6px;">
                                                                    Describa los productos, resultados y principales actividades al cierre del proyecto.
                                                                </div>
                                                                <textarea id="final-productos" maxlength="3200" required oninput="actualizarContadorFinal(this)" style="width: 100%; height: 120px; padding: 8px;"></textarea>
                                                                <div class="contador" id="contador-final-productos">0 / 3200</div>
                                                            </div>

                                                            <div>
                                                                <label for="final-comentarios"><strong>OTROS COMENTARIOS</strong></label>
                                                                <div style="font-size: 13px; margin-bottom: 6px;">
                                                                    Espacio libre para comentarios.
                                                                </div>
                                                                <textarea id="final-comentarios" maxlength="3200" oninput="actualizarContadorFinal(this)" style="width: 100%; height: 120px; padding: 8px;"></textarea>
                                                                <div class="contador" id="contador-final-comentarios">0 / 3200</div>
                                                            </div>

                                                            <div>
                                                                <label for="final-material-pdf"><strong>INFORMACI√ìN PROBATORIA</strong></label>
                                                                <div style="font-size: 13px; margin-bottom: 6px;">
                                                                    Adjunte en un √∫nico PDF todo el material probatorio.
                                                                </div>
                                                                <input type="file" accept="application/pdf" id="final-material-pdf" />
                                                                <div id="archivo-cargado-final" style="font-size: 13px; margin-top: 6px;"></div>
                                                            </div>
                                                        </div>
`;

            cargarCuestionarioFinal(codigo);
        }

        function actualizarContadorFinal(textarea) {
            const id = textarea.id;
            const contador = document.getElementById(`contador-${id}`);
            if (contador) {
                contador.textContent = `${textarea.value.length} / 3200`;
            }
        }

        async function guardarCuestionarioFinal(codigo) {
            const descripcion = document.getElementById("final-descripcion").value.trim();
            const obstaculos = document.getElementById("final-obstaculos").value.trim();
            const productos = document.getElementById("final-productos").value.trim();
            const comentarios = document.getElementById("final-comentarios").value.trim();
            const archivo = document.getElementById("final-material-pdf").files[0];

            if (!descripcion || !obstaculos || !productos) {
                alert("Los primeros tres campos son obligatorios.");
                return;
            }

            try {
                let urlArchivo = null;
                if (archivo) {
                    const storageRef = firebase.storage().ref().child(`material/${codigo}/material_probatorio.pdf`);
                    await storageRef.put(archivo);
                    urlArchivo = await storageRef.getDownloadURL();
                }

                await firebase.firestore().collection("informes_finales").doc(codigo).set({
                    descripcion,
                    obstaculos,
                    productos,
                    comentarios,
                    urlArchivo
                }, { merge: true });

                document.getElementById("archivo-cargado-final").textContent = archivo ? `Archivo subido: ${archivo.name}` : "";
                alert("Cuestionario guardado correctamente.");
            } catch (error) {
                console.error("Error al guardar el cuestionario final:", error);
                alert("Ocurri√≥ un error al guardar.");
            }
        }

        async function cargarCuestionarioFinal(codigo) {
            try {
                const doc = await firebase.firestore().collection("informes_finales").doc(codigo).get();
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById("final-descripcion").value = data.descripcion || "";
                    document.getElementById("final-obstaculos").value = data.obstaculos || "";
                    document.getElementById("final-productos").value = data.productos || "";
                    document.getElementById("final-comentarios").value = data.comentarios || "";

                    actualizarContadorFinal(document.getElementById("final-descripcion"));
                    actualizarContadorFinal(document.getElementById("final-obstaculos"));
                    actualizarContadorFinal(document.getElementById("final-productos"));
                    actualizarContadorFinal(document.getElementById("final-comentarios"));

                    if (data.urlArchivo) {
                        document.getElementById("archivo-cargado-final").innerHTML = `
                                                                Archivo cargado: <a href="${data.urlArchivo}" target="_blank">Ver PDF</a>
                                                            `;
                    }

                    // üö´ Si ya fue enviado, deshabilitar campos y botones
                    if (data.enviado === true) {
                        document.querySelectorAll('#tab-cuestionario textarea, #final-material-pdf').forEach(el => el.disabled = true);
                        document.getElementById("btn-guardar-informe-final").disabled = true;
                        document.getElementById("btn-enviar-informe-final").disabled = true;

                        // Opcional: marcar visualmente que est√° enviado
                        document.getElementById("btn-enviar-informe-final").textContent = "Informe enviado";
                        if (data.fechaEnvio) {
                            const fecha = new Date(data.fechaEnvio);
                            const fechaFormateada = fecha.toLocaleString("es-AR", {
                                day: '2-digit', month: '2-digit', year: 'numeric',
                                hour: '2-digit', minute: '2-digit'
                            });

                            const cartel = document.createElement("div");
                            cartel.textContent = `‚úÖ Informe final enviado el: ${fechaFormateada}`;
                            cartel.style = "margin-top: 20px; padding: 10px; background: #d4edda; color: #155724; border: 1px solid #c3e6cb; border-radius: 5px;";
                            document.getElementById("tab-cuestionario").prepend(cartel);
                        }
                    }
                }
            } catch (error) {
                console.error("Error al cargar cuestionario final:", error);
            }
        }
        async function cargarRRHHFinal(codigo) {
            try {
                const snapshot = await firebase.firestore()
                    .collection("informes_finales")
                    .doc(codigo)
                    .collection("rrhh")
                    .get();

                const tbody = document.querySelector("#tabla-rrhh tbody");
                tbody.innerHTML = "";

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const fila = document.createElement("tr");
                    fila.setAttribute("data-id", doc.id);
                    fila.innerHTML = generarFilaRRHHHTML(data.nombre, data.apellido, data.cuit, data.tipo, doc.id, codigo);
                    tbody.appendChild(fila);
                });

                const docProyecto = await firebase.firestore().collection("informes_finales").doc(codigo).get();
                if (docProyecto.exists && docProyecto.data().enviado === true) {
                    document.querySelectorAll('#form-rrhh input, #form-rrhh select, #form-rrhh button').forEach(el => el.disabled = true);
                }

            } catch (error) {
                console.error("Error al cargar RRHH:", error);
            }
        }
    </script>
    <script>
        let idRRHHEditando = null;

        function agregarRRHH() {
            const nombre = document.getElementById("rrhh-nombre").value.trim();
            const apellido = document.getElementById("rrhh-apellido").value.trim();
            const cuit = document.getElementById("rrhh-cuit").value.trim();
            const tipo = document.getElementById("rrhh-tipo").value;

            if (!/^\d{11}$/.test(cuit)) {
                alert("El CUIT debe tener exactamente 11 d√≠gitos.");
                return;
            }

            const tbody = document.querySelector("#tabla-rrhh tbody");

            if (idRRHHEditando) {
                // Actualizar fila existente
                const fila = document.querySelector(`tr[data-id='${idRRHHEditando}']`);
                fila.innerHTML = generarFilaRRHHHTML(nombre, apellido, cuit, tipo, idRRHHEditando);
                idRRHHEditando = null;
                document.getElementById("btn-agregar-rrhh").textContent = "Agregar RRHH";
                document.getElementById("btn-cancelar-edicion-rrhh").style.display = "none";
            } else {
                // Generar ID temporal √∫nico
                const id = "rrhh_" + Date.now();
                const fila = document.createElement("tr");
                fila.setAttribute("data-id", id);
                fila.innerHTML = generarFilaRRHHHTML(nombre, apellido, cuit, tipo, id);
                tbody.appendChild(fila);
            }

            // Limpiar formulario
            document.getElementById("form-rrhh").reset();
        }

        function generarFilaRRHHHTML(nombre, apellido, cuit, tipo, id, codigo) {
            return `
                <td>${nombre}</td>
                <td>${apellido}</td>
                <td>${cuit}</td>
                <td>${tipo}</td>
                <td style="text-align:center;">
                    <span onclick="editarRRHH('${id}')" style="cursor:pointer; color:blue; margin-right: 8px;">‚úé</span>
                    <span onclick="eliminarRRHH('${codigo}', '${id}')" style="cursor:pointer; color:red;">‚úñ</span>
                </td>
            `;
        }

        function editarRRHH(id) {
            const fila = document.querySelector(`tr[data-id='${id}']`);
            if (!fila) return;

            const celdas = fila.querySelectorAll("td");
            document.getElementById("rrhh-nombre").value = celdas[0].textContent;
            document.getElementById("rrhh-apellido").value = celdas[1].textContent;
            document.getElementById("rrhh-cuit").value = celdas[2].textContent;
            document.getElementById("rrhh-tipo").value = celdas[3].textContent;

            idRRHHEditando = id;
            document.getElementById("btn-agregar-rrhh").textContent = "Actualizar RRHH";
            document.getElementById("btn-cancelar-edicion-rrhh").style.display = "inline-block";
        }

        async function eliminarRRHH(codigo, id) {
            const fila = document.querySelector(`tr[data-id='${id}']`);
            if (!fila || !confirm("¬øEst√°s seguro que quer√©s eliminar este registro?")) return;

            fila.remove();

            if (!id.startsWith("rrhh_")) {
                try {
                    await firebase.firestore()
                        .collection("informes_finales")
                        .doc(codigo)
                        .collection("rrhh")
                        .doc(id)
                        .delete();
                } catch (error) {
                    console.error("Error al eliminar de Firebase:", error);
                    alert("No se pudo eliminar de la base de datos.");
                }
            }

            if (idRRHHEditando === id) cancelarEdicionRRHH();
        }

        function cancelarEdicionRRHH() {
            idRRHHEditando = null;
            document.getElementById("form-rrhh").reset();
            document.getElementById("btn-agregar-rrhh").textContent = "Agregar RRHH";
            document.getElementById("btn-cancelar-edicion-rrhh").style.display = "none";
        }
    </script>


    <script>
        async function guardarInformeFinal(codigo) {
            mostrarCargando();

            try {
                await guardarCuestionarioFinal(codigo);
                await guardarFormacionRRHH(codigo);  // ‚¨ÖÔ∏è Nueva l√≠nea
                mostrarMensajeVerde("Informe final guardado correctamente.");
            } catch (error) {
                console.error("Error al guardar informe final:", error);
                alert("Ocurri√≥ un error al guardar el informe final.");
            }

            ocultarCargando();
        }

        function mostrarMensajeVerde(mensaje) {
            const div = document.createElement("div");
            div.textContent = mensaje;
            div.style.background = "#d4edda";
            div.style.color = "#155724";
            div.style.border = "1px solid #c3e6cb";
            div.style.padding = "12px";
            div.style.marginTop = "20px";
            div.style.borderRadius = "6px";
            div.style.maxWidth = "800px";

            const contenedor = document.querySelector("#tab-cuestionario");
            if (contenedor) contenedor.appendChild(div);

            setTimeout(() => div.remove(), 4000);
        }
    </script>
    <script>
        function mostrarModalConfirmacionFinal() {
            const modal = document.getElementById("modal-confirmacion-final");
            if (modal) modal.style.display = "flex";
        }

        function cerrarModalConfirmacionFinal() {
            const modal = document.getElementById("modal-confirmacion-final");
            if (modal) modal.style.display = "none";
        }

        async function confirmarEnvioInformeFinal(codigo) {
            cerrarModalConfirmacionFinal();
            mostrarCargando();

            try {
                await guardarCuestionarioFinal(codigo); // Asegurarse de guardar antes de marcar como enviado
                await guardarFormacionRRHH(codigo);

                const fechaEnvio = new Date().toISOString();

                await firebase.firestore().collection("informes_finales").doc(codigo).set({
                    enviado: true,
                    fechaEnvio: fechaEnvio
                }, { merge: true });

                alert("Informe final enviado correctamente.");
                cargarCuestionarioFinal(codigo); // Vuelve a cargar con bloqueo
            } catch (error) {
                console.error("Error al enviar informe final:", error);
                alert("Ocurri√≥ un error al enviar el informe.");
            } finally {
                ocultarCargando();
            }
        }
    </script>
    <script>
        async function guardarFormacionRRHH(codigo) {
            const filas = document.querySelectorAll("#tabla-rrhh tbody tr");

            const rrhhRef = firebase.firestore()
                .collection("informes_finales")
                .doc(codigo)
                .collection("rrhh");

            // Eliminar todos los documentos previos
            const snapshot = await rrhhRef.get();
            const batch = firebase.firestore().batch();
            snapshot.forEach(doc => batch.delete(doc.ref));
            await batch.commit();

            // Agregar los actuales
            for (const fila of filas) {
                const nombre = fila.cells[0].textContent.trim();
                const apellido = fila.cells[1].textContent.trim();
                const cuit = fila.cells[2].textContent.trim();
                const tipo = fila.cells[3].textContent.trim();

                await rrhhRef.add({
                    nombre,
                    apellido,
                    cuit,
                    tipo
                });
            }
        }
    </script>
    <script>
        function mostrarCamposProduccion() {
            const tipo = document.getElementById("tipo-produccion").value;
            const esArticulo = tipo === "Art√≠culos publicados en revistas";
            document.getElementById("campos-articulo").style.display = esArticulo ? "block" : "none";
        }

        async function buscarPorDOI() {
            const doi = document.getElementById("doi-articulo").value.trim();
            if (!doi) return alert("Ingrese un DOI v√°lido.");

            try {
                const res = await fetch(`https://api.crossref.org/works/${encodeURIComponent(doi)}`);
                const data = await res.json();
                const info = data.message;

                document.getElementById("titulo-articulo").value = info.title?.[0] || "";
                document.getElementById("autores-articulo").value = info.author?.map(a => `${a.given} ${a.family}`).join(", ") || "";
                document.getElementById("revista-articulo").value = info["container-title"]?.[0] || "";
                document.getElementById("anio-articulo").value = info.issued?.["date-parts"]?.[0]?.[0] || "";
                document.getElementById("volumen-articulo").value = info.volume || "";
                document.getElementById("numero-articulo").value = info.issue || "";
                document.getElementById("paginas-articulo").value = info.page || "";
                document.getElementById("url-articulo").value = info.URL || "";

                // Nuevo: ISSN y Editorial
                document.getElementById("issn-articulo").value = info.ISSN?.[0] || "";
                document.getElementById("editorial-articulo").value = info.publisher || "";

            } catch (err) {
                console.error("Error al consultar Crossref:", err);
                alert("No se pudo obtener informaci√≥n del DOI.");
            }
        }
        async function buscarPorISSN() {
            const issn = document.getElementById("buscar-issn").value.trim(); // <--- el input editable ahora tiene id="buscar-issn"
            if (!issn) return alert("Ingrese un ISSN v√°lido.");

            try {
                const res = await fetch(`https://api.openalex.org/sources?filter=issn:${encodeURIComponent(issn)}`);
                const data = await res.json();

                if (!data.results || data.results.length === 0) {
                    alert("No se encontraron resultados para ese ISSN.");
                    return;
                }

                const info = data.results[0];

                // Completar campos visibles en el formulario
                document.getElementById("revista-articulo").value = info.display_name || "";
                document.getElementById("editorial-articulo").value = info.host_organization_name || "";
                document.getElementById("issn-articulo").value = info.issn_l || "";  // este campo es readonly

            } catch (err) {
                console.error("Error al consultar OpenAlex:", err);
                alert("No se pudo obtener informaci√≥n del ISSN.");
            }
        }


        async function buscarPorISBN() {
            const isbn = document.getElementById("isbn-articulo").value.trim().replace(/-/g, "");
            if (!isbn) return alert("Ingrese un ISBN v√°lido.");

            try {
                const res = await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${isbn}&jscmd=data&format=json`);
                const data = await res.json();
                const info = data[`ISBN:${isbn}`];

                if (!info) return alert("No se encontr√≥ informaci√≥n para ese ISBN.");

                document.getElementById("titulo-articulo").value = info.title || "";
                document.getElementById("editorial-articulo").value = info.publishers?.[0]?.name || "";
                document.getElementById("revista-articulo").value = info.publish_places?.[0]?.name || "";

            } catch (err) {
                console.error("Error al consultar Open Library:", err);
                alert("No se pudo obtener informaci√≥n del ISBN.");
            }
        }
        function mostrarInfoDOI() {
            document.getElementById("modal-info-doi").style.display = "block";
        }

        function cerrarModalInfoDOI() {
            document.getElementById("modal-info-doi").style.display = "none";
        }

        function mostrarInfoISSN() {
            document.getElementById("modal-info-issn").style.display = "block";
        }

        function cerrarModalInfoISSN() {
            document.getElementById("modal-info-issn").style.display = "none";
        }
        let producciones = [];
        let idProduccionEditando = null;

        function agregarProduccion() {
            const tipo = document.getElementById("tipo-produccion").value;
            const titulo = document.getElementById("titulo-articulo").value;
            const autores = document.getElementById("autores-articulo").value;
            const revista = document.getElementById("revista-articulo").value;
            const anio = document.getElementById("anio-articulo").value;

            const produccion = {
                tipo, titulo, autores, revista, anio,
                volumen: document.getElementById("volumen-articulo").value,
                numero: document.getElementById("numero-articulo").value,
                paginas: document.getElementById("paginas-articulo").value,
                url: document.getElementById("url-articulo").value,
                doi: document.getElementById("doi-articulo").value,
                id: idProduccionEditando || Date.now().toString()
            };

            if (idProduccionEditando) {
                producciones = producciones.map(p => p.id === idProduccionEditando ? produccion : p);
                idProduccionEditando = null;
            } else {
                producciones.push(produccion);
            }

            limpiarFormularioProduccion();
            renderizarTablaProduccion();
        }

        function renderizarTablaProduccion() {
            const tbody = document.getElementById("tbody-produccion");
            tbody.innerHTML = "";

            producciones.forEach(prod => {
                const fila = document.createElement("tr");
                fila.setAttribute("data-id", prod.id);
                fila.innerHTML = `
                    <td>${prod.tipo}</td>
                    <td>${prod.titulo}</td>
                    <td>${prod.autores}</td>
                    <td>${prod.revista}</td>
                    <td>${prod.anio}</td>
                    <td style="text-align:center;">
                        <span onclick="editarProduccion('${prod.id}')" style="cursor:pointer; color:blue; margin-right: 8px;">‚úé</span>
                        <span onclick="eliminarProduccion('${prod.id}')" style="cursor:pointer; color:red;">‚úñ</span>
                    </td>
                `;
                tbody.appendChild(fila);
            });
        }

        function limpiarFormularioProduccion() {
            document.getElementById("tipo-produccion").value = "";
            document.getElementById("doi-articulo").value = "";
            document.getElementById("titulo-articulo").value = "";
            document.getElementById("autores-articulo").value = "";
            document.getElementById("revista-articulo").value = "";
            document.getElementById("anio-articulo").value = "";
            document.getElementById("volumen-articulo").value = "";
            document.getElementById("numero-articulo").value = "";
            document.getElementById("paginas-articulo").value = "";
            document.getElementById("url-articulo").value = "";
            document.getElementById("campos-articulo").style.display = "none";
        }

        function editarProduccion(id) {
            const prod = producciones.find(p => p.id === id);
            if (!prod) return;

            idProduccionEditando = id;
            document.getElementById("tipo-produccion").value = prod.tipo;
            mostrarCamposProduccion();

            document.getElementById("doi-articulo").value = prod.doi || "";
            document.getElementById("titulo-articulo").value = prod.titulo || "";
            document.getElementById("autores-articulo").value = prod.autores || "";
            document.getElementById("revista-articulo").value = prod.revista || "";
            document.getElementById("anio-articulo").value = prod.anio || "";
            document.getElementById("volumen-articulo").value = prod.volumen || "";
            document.getElementById("numero-articulo").value = prod.numero || "";
            document.getElementById("paginas-articulo").value = prod.paginas || "";
            document.getElementById("url-articulo").value = prod.url || "";
        }

        function eliminarProduccion(id) {
            if (!confirm("¬øDese√°s eliminar esta producci√≥n?")) return;
            producciones = producciones.filter(p => p.id !== id);
            renderizarTablaProduccion();
        }
    </script>
    <script>
        firebase.auth().onAuthStateChanged(async user => {
            const authContainer = document.getElementById("auth-container");
            const mainInterface = document.getElementById("main-interface");
            const saludo = document.getElementById("saludo-usuario");
            const menuToggle = document.getElementById("menu-toggle");
            const sidebar = document.getElementById("sidebar");

            document.getElementById("modal-cargando").style.display = "none"; // Oculta 'Cargando...'

            if (user && user.emailVerified) {
                authContainer.style.display = "none";
                mainInterface.style.display = "block";
                if (menuToggle) menuToggle.style.display = "block";
                if (sidebar) sidebar.style.display = "block";

                const doc = await firebase.firestore().collection("usuarios").doc(user.uid).get();
                if (doc.exists) {
                    const data = doc.data();
                    saludo.textContent = `Hola ${data.nombre} ${data.apellido}`;
                } else {
                    saludo.textContent = "Hola usuario";
                }

                // Esperar un poco para asegurar render completo, luego manejar el hash actual
                setTimeout(() => manejarCambioHash(), 100);

                // Tambi√©n asegurarse de que cualquier cambio posterior de hash se maneje
                window.addEventListener("hashchange", manejarCambioHash);

            } else {
                authContainer.style.display = "block";
                mainInterface.style.display = "none";
                if (menuToggle) menuToggle.style.display = "none";
                if (sidebar) sidebar.style.display = "none";
            }
        });

        // Definir la funci√≥n √∫nica para manejar el hash
        function manejarCambioHash() {
            const user = firebase.auth().currentUser;
            if (!user || !user.emailVerified) return;

            const hash = location.hash;
            console.log("HASH ACTUAL:", hash);  // üëâ Ver qu√© valor tiene

            if (hash === "#mis-proyectos") {
                mostrarMisProyectos();
            } else if (hash.startsWith("#ver-proyecto-")) {
                const projectId = hash.replace("#ver-proyecto-", "");
                verProyecto(projectId);
            } else if (hash === "#informe-parcial") {
                mostrarInformeParcial(codigoProyectoActual);
            } else if (hash === "#informe-final") {
                mostrarInformeFinal(codigoProyectoActual);
            } else {
                mostrarInicio(); // fallback
            }
        }
    </script>
    <!-- Modal para informaci√≥n DOI -->
    <div id="modal-info-doi" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:white; padding:20px; border:1px solid #ccc; border-radius:10px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index:1000;">
        <h3>¬øQu√© es el DOI y qu√© usamos?</h3>
        <p>El sistema <strong>SIAP-UNTREF</strong> utiliza <strong>Crossref</strong> para consultar autom√°ticamente los datos del art√≠culo ingresando su DOI (Digital Object Identifier). Esta base internacional garantiza resultados confiables para art√≠culos cient√≠ficos registrados.</p>
        <button onclick="cerrarModalInfoDOI()">Cerrar</button>
    </div>

    <!-- Modal para informaci√≥n ISSN -->
    <div id="modal-info-issn" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:white; padding:20px; border:1px solid #ccc; border-radius:10px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index:1000;">
        <h3>¬øQu√© es el ISSN y qu√© usamos?</h3>
        <p>El sistema <strong>SIAP-UNTREF</strong> utiliza <strong>OpenAlex</strong> para consultar datos sobre revistas cient√≠ficas a partir del ISSN (International Standard Serial Number). Esto permite completar autom√°ticamente campos como nombre de la revista y editorial.</p>
        <button onclick="cerrarModalInfoISSN()">Cerrar</button>
    </div>
</body>
</html >
